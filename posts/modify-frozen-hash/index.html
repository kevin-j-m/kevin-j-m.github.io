<!doctype html>

<html lang="en">

<head>
  <title>Duped into modifying a frozen hash - Kevin Murphy</title>
  <meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<meta name="description" content="Calling freeze on an object may not provide the immutability you expect. Here we dig into some of freeze&#39;s nuances to explore a surprise of my own making I encountered working with ActiveSupport." />
<meta name="author" content="Kevin Murphy" />

<link rel="canonical" href="https://kevinjmurphy.com/posts/modify-frozen-hash/">
<meta property="og:title" content="Duped into modifying a frozen hash" />
<meta property="og:description" content="Calling freeze on an object may not provide the immutability you expect. Here we dig into some of freeze&#39;s nuances to explore a surprise of my own making I encountered working with ActiveSupport." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://kevinjmurphy.com/posts/modify-frozen-hash/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-02-17T19:00:00-04:00" />
<meta property="article:modified_time" content="2023-02-17T19:00:00-04:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Duped into modifying a frozen hash"/>
<meta name="twitter:description" content="Calling freeze on an object may not provide the immutability you expect. Here we dig into some of freeze&#39;s nuances to explore a surprise of my own making I encountered working with ActiveSupport."/>

<meta name="generator" content="Hugo 0.109.0">
    

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.1/normalize.min.css" integrity="sha256-l85OmPOjvil/SOvVt3HnSSjzF1TUMyT9eV0c2BzEGzU=" crossorigin="anonymous" />
  <link rel="stylesheet" href="https://kevinjmurphy.com/fontawesome/css/all.min.css" />
  
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto+Slab|Ruda" />
  
  
  <link rel="stylesheet" type="text/css" href="https://kevinjmurphy.com/css/styles.css" /><link rel='stylesheet' href='https://kevinjmurphy.com/css/link-style.css'><link rel='stylesheet' href='https://kevinjmurphy.com/css/code-scroll.css'><link rel='stylesheet' href='https://kevinjmurphy.com/css/coverage-emoji.css'><link rel='stylesheet' href='https://kevinjmurphy.com/css/header-name.css'><link rel='stylesheet' href='https://kevinjmurphy.com/css/search.css'>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-RVD6VLNE04"></script>
<script>
var doNotTrack = false;
if (!doNotTrack) {
	window.dataLayer = window.dataLayer || [];
	function gtag(){dataLayer.push(arguments);}
	gtag('js', new Date());
	gtag('config', 'G-RVD6VLNE04', { 'anonymize_ip': false });
}
</script>

  
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'G-RVD6VLNE04', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

</head>

<body>
  <div id="container">
    <header>
      <div class="header-name">
                <a href="https://kevinjmurphy.com/">Kevin Murphy</a>
            </div>

      <ul id="social-media">
             <li>
               <a href="https://github.com/kevin-j-m" title="GitHub">
               <i class="fab fa-github fa-lg"></i>
               </a>
             </li>
             <li>
               <a href="https://twitter.com/kevin_j_m" title="Twitter">
               <i class="fab fa-twitter fa-lg"></i>
               </a>
             </li>
             <li>
               <a href="https://linkedin.com/in/kevinmurphydev" title="LinkedIn">
               <i class="fab fa-linkedin fa-lg"></i>
               </a>
             </li>
             <li>
               <a href="https://ruby.social/@kevin_j_m" title="Mastodon">
               <i class="fab fa-mastodon fa-lg"></i>
               </a>
             </li>
             <li>
               <a href="https://dev.to/kevin_j_m" title="devto">
               <i class="fab fa-dev fa-lg"></i>
               </a>
             </li>
        <li>
          <a rel="me" href="https://ruby.social/@kevin_j_m">
          </a>
        </li>
      </ul>
      
      <p><em>Software Developer</em></p>
      
    </header>

    
<nav>
    <ul>
        
        <li>
            <a class="" href="https://kevinjmurphy.com/">
                <i class="fa-li fa  fa-lg"></i><span>Home</span>
            </a>
        </li>
        
        <li>
            <a class="" href="https://kevinjmurphy.com/about/">
                <i class="fa-li fa  fa-lg"></i><span>About</span>
            </a>
        </li>
        
        <li>
            <a class="" href="https://kevinjmurphy.com/speaking/">
                <i class="fa-li fa  fa-lg"></i><span>Speaking</span>
            </a>
        </li>
        
        <li>
            <a class="" href="https://kevinjmurphy.com/search/">
                <i class="fa-li fa  fa-lg"></i><span>Search</span>
            </a>
        </li>
        
        <li>
          <a href="https://newsletter.kevinjmurphy.com">
                <i class="fa-li fa fa-lg"></i><span>Newsletter</span>
          </a>
        </li>
    </ul>
</nav>


    <main>




<article>

    <h1>Duped into modifying a frozen hash</h1>

    
      <aside>
    <ul>
        <li>
            <time class="post-date" data-pagefind-sort="date:2023-02-17" datetime="2023-02-17T19:00:00-04:00">Feb 17, 2023</time>
        </li>
        
        

        
        <li>
            <em>
                
                    
                    <a href="https://kevinjmurphy.com/tags/ruby">#ruby</a>
                
                    , 
                    <a href="https://kevinjmurphy.com/tags/rails">#rails</a>
                
            </em>
        </li>
        

        <li>5 minute read | 889 words</li>
    </ul>
</aside>

    

    


    <h2 id="flash-freeze">Flash Freeze <a href="#flash-freeze">ðŸ”—</a></h2>
<p>You can freeze a hash to prevent modifying its contents. The effect of freezing the hash is only one level deep. The values in the hash aren&rsquo;t frozen. As expected, I can&rsquo;t change the entire value of a key.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ruby" data-lang="ruby"><span style="display:flex;"><span>irb(main):<span style="color:#ae81ff">001</span>:<span style="color:#ae81ff">0</span><span style="color:#f92672">&gt;</span> h <span style="color:#f92672">=</span> { <span style="color:#e6db74">c</span>: <span style="color:#e6db74">&#34;three&#34;</span> }
</span></span><span style="display:flex;"><span><span style="color:#f92672">=&gt;</span> {<span style="color:#e6db74">:c</span><span style="color:#f92672">=&gt;</span><span style="color:#e6db74">&#34;three&#34;</span>}
</span></span><span style="display:flex;"><span>irb(main):<span style="color:#ae81ff">002</span>:<span style="color:#ae81ff">0</span><span style="color:#f92672">&gt;</span> frozen <span style="color:#f92672">=</span> h<span style="color:#f92672">.</span>freeze
</span></span><span style="display:flex;"><span><span style="color:#f92672">=&gt;</span> {<span style="color:#e6db74">:c</span><span style="color:#f92672">=&gt;</span><span style="color:#e6db74">&#34;three&#34;</span>}
</span></span><span style="display:flex;"><span>irb(main):<span style="color:#ae81ff">003</span>:<span style="color:#ae81ff">0</span><span style="color:#f92672">&gt;</span> frozen<span style="color:#f92672">[</span><span style="color:#e6db74">:c</span><span style="color:#f92672">]</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;four&#34;</span>
</span></span><span style="display:flex;"><span>(irb):<span style="color:#ae81ff">13</span><span style="color:#e6db74">:in</span> <span style="color:#e6db74">`&lt;main&gt;&#39;: can&#39;t modify frozen Hash: {:c=&gt;&#34;three&#34;} (FrozenError)
</span></span></span></code></pre></div><p>However, I can modify a string value in the frozen hash.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ruby" data-lang="ruby"><span style="display:flex;"><span>irb(main):<span style="color:#ae81ff">001</span>:<span style="color:#ae81ff">0</span><span style="color:#f92672">&gt;</span> h <span style="color:#f92672">=</span> { <span style="color:#e6db74">c</span>: <span style="color:#e6db74">&#34;three&#34;</span> }
</span></span><span style="display:flex;"><span><span style="color:#f92672">=&gt;</span> {<span style="color:#e6db74">:c</span><span style="color:#f92672">=&gt;</span><span style="color:#e6db74">&#34;three&#34;</span>}
</span></span><span style="display:flex;"><span>irb(main):<span style="color:#ae81ff">002</span>:<span style="color:#ae81ff">0</span><span style="color:#f92672">&gt;</span> frozen <span style="color:#f92672">=</span> h<span style="color:#f92672">.</span>freeze
</span></span><span style="display:flex;"><span><span style="color:#f92672">=&gt;</span> {<span style="color:#e6db74">:c</span><span style="color:#f92672">=&gt;</span><span style="color:#e6db74">&#34;three&#34;</span>}
</span></span><span style="display:flex;"><span>irb(main):<span style="color:#ae81ff">003</span>:<span style="color:#ae81ff">0</span><span style="color:#f92672">&gt;</span> frozen<span style="color:#f92672">[</span><span style="color:#e6db74">:c</span><span style="color:#f92672">].</span>upcase!
</span></span><span style="display:flex;"><span><span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">&#34;THREE&#34;</span>
</span></span><span style="display:flex;"><span>irb(main):<span style="color:#ae81ff">004</span>:<span style="color:#ae81ff">0</span><span style="color:#f92672">&gt;</span> frozen
</span></span><span style="display:flex;"><span><span style="color:#f92672">=&gt;</span> {<span style="color:#e6db74">:c</span><span style="color:#f92672">=&gt;</span><span style="color:#e6db74">&#34;THREE&#34;</span>}
</span></span></code></pre></div><p>I can also modify a hash inside the frozen hash.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ruby" data-lang="ruby"><span style="display:flex;"><span>irb(main):<span style="color:#ae81ff">001</span>:<span style="color:#ae81ff">0</span><span style="color:#f92672">&gt;</span> h <span style="color:#f92672">=</span> { <span style="color:#e6db74">a</span>: { <span style="color:#e6db74">b</span>: <span style="color:#ae81ff">2</span> } }
</span></span><span style="display:flex;"><span><span style="color:#f92672">=&gt;</span> {<span style="color:#e6db74">:a</span><span style="color:#f92672">=&gt;</span>{<span style="color:#e6db74">:b</span><span style="color:#f92672">=&gt;</span><span style="color:#ae81ff">2</span>}}
</span></span><span style="display:flex;"><span>irb(main):<span style="color:#ae81ff">002</span>:<span style="color:#ae81ff">0</span><span style="color:#f92672">&gt;</span> frozen <span style="color:#f92672">=</span> h<span style="color:#f92672">.</span>freeze
</span></span><span style="display:flex;"><span><span style="color:#f92672">=&gt;</span> {<span style="color:#e6db74">:a</span><span style="color:#f92672">=&gt;</span>{<span style="color:#e6db74">:b</span><span style="color:#f92672">=&gt;</span><span style="color:#ae81ff">2</span>}}
</span></span><span style="display:flex;"><span>irb(main):<span style="color:#ae81ff">003</span>:<span style="color:#ae81ff">0</span><span style="color:#f92672">&gt;</span> frozen<span style="color:#f92672">[</span><span style="color:#e6db74">:a</span><span style="color:#f92672">][</span><span style="color:#e6db74">:b</span><span style="color:#f92672">]</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">4</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">=&gt;</span> <span style="color:#ae81ff">4</span>
</span></span><span style="display:flex;"><span>irb(main):<span style="color:#ae81ff">004</span>:<span style="color:#ae81ff">0</span><span style="color:#f92672">&gt;</span> frozen
</span></span><span style="display:flex;"><span><span style="color:#f92672">=&gt;</span> {<span style="color:#e6db74">:a</span><span style="color:#f92672">=&gt;</span>{<span style="color:#e6db74">:b</span><span style="color:#f92672">=&gt;</span><span style="color:#ae81ff">4</span>}}
</span></span></code></pre></div><p>And modify an array inside the frozen hash.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ruby" data-lang="ruby"><span style="display:flex;"><span>irb(main):<span style="color:#ae81ff">001</span>:<span style="color:#ae81ff">0</span><span style="color:#f92672">&gt;</span> h <span style="color:#f92672">=</span> { <span style="color:#e6db74">d</span>: <span style="color:#f92672">[</span><span style="color:#ae81ff">4</span>, <span style="color:#ae81ff">5</span>, <span style="color:#ae81ff">6</span><span style="color:#f92672">]</span> }
</span></span><span style="display:flex;"><span><span style="color:#f92672">=&gt;</span> {<span style="color:#e6db74">:d</span><span style="color:#f92672">=&gt;[</span><span style="color:#ae81ff">4</span>, <span style="color:#ae81ff">5</span>, <span style="color:#ae81ff">6</span><span style="color:#f92672">]</span>}
</span></span><span style="display:flex;"><span>irb(main):<span style="color:#ae81ff">002</span>:<span style="color:#ae81ff">0</span><span style="color:#f92672">&gt;</span> frozen <span style="color:#f92672">=</span> h<span style="color:#f92672">.</span>freeze
</span></span><span style="display:flex;"><span><span style="color:#f92672">=&gt;</span> {<span style="color:#e6db74">:d</span><span style="color:#f92672">=&gt;[</span><span style="color:#ae81ff">4</span>, <span style="color:#ae81ff">5</span>, <span style="color:#ae81ff">6</span><span style="color:#f92672">]</span>}
</span></span><span style="display:flex;"><span>irb(main):<span style="color:#ae81ff">003</span>:<span style="color:#ae81ff">0</span><span style="color:#f92672">&gt;</span> frozen<span style="color:#f92672">[</span><span style="color:#e6db74">:d</span><span style="color:#f92672">].</span>map!(<span style="color:#f92672">&amp;</span><span style="color:#e6db74">:even?</span>)
</span></span><span style="display:flex;"><span><span style="color:#f92672">=&gt;</span> <span style="color:#f92672">[</span><span style="color:#66d9ef">true</span>, <span style="color:#66d9ef">false</span>, <span style="color:#66d9ef">true</span><span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>irb(main):<span style="color:#ae81ff">004</span>:<span style="color:#ae81ff">0</span><span style="color:#f92672">&gt;</span> frozen
</span></span><span style="display:flex;"><span><span style="color:#f92672">=&gt;</span> {<span style="color:#e6db74">:d</span><span style="color:#f92672">=&gt;[</span><span style="color:#66d9ef">true</span>, <span style="color:#66d9ef">false</span>, <span style="color:#66d9ef">true</span><span style="color:#f92672">]</span>}
</span></span></code></pre></div><p>I can modify an instance of an object inside a frozen hash.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ruby" data-lang="ruby"><span style="display:flex;"><span>irb(main):<span style="color:#ae81ff">001</span>:<span style="color:#ae81ff">0</span><span style="color:#f92672">&gt;</span> h <span style="color:#f92672">=</span> { <span style="color:#e6db74">a</span>: <span style="color:#66d9ef">User</span><span style="color:#f92672">.</span>new(<span style="color:#e6db74">first_name</span>: <span style="color:#e6db74">&#34;Alice&#34;</span>) }
</span></span><span style="display:flex;"><span><span style="color:#f92672">=&gt;</span> {<span style="color:#e6db74">:a</span><span style="color:#f92672">=&gt;</span><span style="color:#75715e">#&lt;User:0x000000010b50f8c8 @first_name=&#34;Alice&#34;&gt;}</span>
</span></span><span style="display:flex;"><span>irb(main):<span style="color:#ae81ff">002</span>:<span style="color:#ae81ff">0</span><span style="color:#f92672">&gt;</span> frozen <span style="color:#f92672">=</span> h<span style="color:#f92672">.</span>freeze
</span></span><span style="display:flex;"><span><span style="color:#f92672">=&gt;</span> {<span style="color:#e6db74">:a</span><span style="color:#f92672">=&gt;</span><span style="color:#75715e">#&lt;User:0x000000010b50f8c8 @first_name=&#34;Alice&#34;&gt;}</span>
</span></span><span style="display:flex;"><span>irb(main):<span style="color:#ae81ff">003</span>:<span style="color:#ae81ff">0</span><span style="color:#f92672">&gt;</span> frozen<span style="color:#f92672">[</span><span style="color:#e6db74">:a</span><span style="color:#f92672">].</span>first_name <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Carol&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">&#34;Carol&#34;</span>
</span></span><span style="display:flex;"><span>irb(main):<span style="color:#ae81ff">004</span>:<span style="color:#ae81ff">0</span><span style="color:#f92672">&gt;</span> frozen
</span></span><span style="display:flex;"><span><span style="color:#f92672">=&gt;</span> {<span style="color:#e6db74">:a</span><span style="color:#f92672">=&gt;</span><span style="color:#75715e">#&lt;User:0x000000010b50f8c8 @first_name=&#34;Carol&#34;&gt;}</span>
</span></span></code></pre></div><p>The immutability isn&rsquo;t &ldquo;deep&rdquo;. It&rsquo;s shallow. It doesn&rsquo;t nest down to lower levels. Adding deep freezing to Ruby itself has been <a href="https://bugs.ruby-lang.org/issues/2509">discussed</a>. There are also gems that you can use to recursively freeze objects.</p>
<p>The affect of freeze only being shallow isn&rsquo;t specific to a hash. It applies to other data structures and objects as well. However, I specifically want to talk about hashes because&hellip;</p>
<h2 id="frozen-rails-shot">Frozen Rail(s) Shot <a href="#frozen-rails-shot">ðŸ”—</a></h2>
<p>Rails includes a <code>HashWithIndifferentAccess</code> <a href="https://api.rubyonrails.org/classes/ActiveSupport/HashWithIndifferentAccess.html">class</a>. That class considers the keys <code>:a</code> and <code>&quot;a&quot;</code> to be the same key. It&rsquo;s part of <code>ActiveSupport</code>, and that also includes a <a href="https://github.com/rails/rails/blob/7-0-stable/activesupport/lib/active_support/core_ext/hash/indifferent_access.rb#L9-L11">core extension</a> to the hash class. That lets you call <code>.with_indifferent_access</code> on a hash to transform it into a hash with indifferent access.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ruby" data-lang="ruby"><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Hash</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">with_indifferent_access</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">ActiveSupport</span><span style="color:#f92672">::</span><span style="color:#66d9ef">HashWithIndifferentAccess</span><span style="color:#f92672">.</span>new(self)
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">end</span>
</span></span></code></pre></div><p>We can use a <code>HashWithIndifferentAccess</code> like this.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ruby" data-lang="ruby"><span style="display:flex;"><span>irb(main):<span style="color:#ae81ff">001</span>:<span style="color:#ae81ff">0</span><span style="color:#f92672">&gt;</span> h <span style="color:#f92672">=</span> { <span style="color:#e6db74">a</span>: <span style="color:#ae81ff">1</span> }
</span></span><span style="display:flex;"><span><span style="color:#f92672">=&gt;</span> {<span style="color:#e6db74">:a</span><span style="color:#f92672">=&gt;</span><span style="color:#ae81ff">1</span>}
</span></span><span style="display:flex;"><span>irb(main):<span style="color:#ae81ff">002</span>:<span style="color:#ae81ff">0</span><span style="color:#f92672">&gt;</span> h<span style="color:#f92672">[</span><span style="color:#e6db74">:a</span><span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">=&gt;</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>irb(main):<span style="color:#ae81ff">003</span>:<span style="color:#ae81ff">0</span><span style="color:#f92672">&gt;</span> h<span style="color:#f92672">[</span><span style="color:#e6db74">&#34;a&#34;</span><span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">=&gt;</span> <span style="color:#66d9ef">nil</span>
</span></span><span style="display:flex;"><span>irb(main):<span style="color:#ae81ff">004</span>:<span style="color:#ae81ff">0</span><span style="color:#f92672">&gt;</span> indifferent <span style="color:#f92672">=</span> h<span style="color:#f92672">.</span>with_indifferent_access
</span></span><span style="display:flex;"><span><span style="color:#f92672">=&gt;</span> {<span style="color:#e6db74">&#34;a&#34;</span><span style="color:#f92672">=&gt;</span><span style="color:#ae81ff">1</span>}
</span></span><span style="display:flex;"><span>irb(main):<span style="color:#ae81ff">005</span>:<span style="color:#ae81ff">0</span><span style="color:#f92672">&gt;</span> indifferent<span style="color:#f92672">[</span><span style="color:#e6db74">:a</span><span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">=&gt;</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>irb(main):<span style="color:#ae81ff">006</span>:<span style="color:#ae81ff">0</span><span style="color:#f92672">&gt;</span> indifferent<span style="color:#f92672">[</span><span style="color:#e6db74">&#34;a&#34;</span><span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">=&gt;</span> <span style="color:#ae81ff">1</span>
</span></span></code></pre></div><p>You can also freeze a hash with indifferent access. It&rsquo;s like freezing a hash in the ways described above. It still only applies one level deep.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ruby" data-lang="ruby"><span style="display:flex;"><span>irb(main):<span style="color:#ae81ff">001</span>:<span style="color:#ae81ff">0</span><span style="color:#f92672">&gt;</span> h <span style="color:#f92672">=</span> { <span style="color:#e6db74">c</span>: <span style="color:#e6db74">&#34;three&#34;</span> }
</span></span><span style="display:flex;"><span><span style="color:#f92672">=&gt;</span> {<span style="color:#e6db74">:c</span><span style="color:#f92672">=&gt;</span><span style="color:#e6db74">&#34;three&#34;</span>}
</span></span><span style="display:flex;"><span>irb(main):<span style="color:#ae81ff">002</span>:<span style="color:#ae81ff">0</span><span style="color:#f92672">&gt;</span> indifferent <span style="color:#f92672">=</span> h<span style="color:#f92672">.</span>with_indifferent_access
</span></span><span style="display:flex;"><span><span style="color:#f92672">=&gt;</span> {<span style="color:#e6db74">&#34;c&#34;</span><span style="color:#f92672">=&gt;</span><span style="color:#e6db74">&#34;three&#34;</span>}
</span></span><span style="display:flex;"><span>irb(main):<span style="color:#ae81ff">003</span>:<span style="color:#ae81ff">0</span><span style="color:#f92672">&gt;</span> frozen <span style="color:#f92672">=</span> i<span style="color:#f92672">.</span>freeze
</span></span><span style="display:flex;"><span><span style="color:#f92672">=&gt;</span> {<span style="color:#e6db74">&#34;c&#34;</span><span style="color:#f92672">=&gt;</span><span style="color:#e6db74">&#34;three&#34;</span>}
</span></span><span style="display:flex;"><span>irb(main):<span style="color:#ae81ff">004</span>:<span style="color:#ae81ff">0</span><span style="color:#f92672">&gt;</span> frozen<span style="color:#f92672">[</span><span style="color:#e6db74">:c</span><span style="color:#f92672">]</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;four&#34;</span>
</span></span><span style="display:flex;"><span>can<span style="color:#960050;background-color:#1e0010">&#39;</span>t modify frozen <span style="color:#66d9ef">ActiveSupport</span><span style="color:#f92672">::</span><span style="color:#e6db74">HashWithIndifferentAccess</span>: {<span style="color:#e6db74">&#34;c&#34;</span><span style="color:#f92672">=&gt;</span><span style="color:#e6db74">&#34;three&#34;</span>} (<span style="color:#66d9ef">FrozenError</span>)
</span></span><span style="display:flex;"><span>irb(main):<span style="color:#ae81ff">005</span>:<span style="color:#ae81ff">0</span><span style="color:#f92672">&gt;</span> frozen<span style="color:#f92672">[</span><span style="color:#e6db74">:c</span><span style="color:#f92672">].</span>upcase!
</span></span><span style="display:flex;"><span><span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">&#34;THREE&#34;</span>
</span></span><span style="display:flex;"><span>irb(main):<span style="color:#ae81ff">006</span>:<span style="color:#ae81ff">0</span><span style="color:#f92672">&gt;</span> frozen
</span></span><span style="display:flex;"><span><span style="color:#f92672">=&gt;</span> {<span style="color:#e6db74">&#34;c&#34;</span><span style="color:#f92672">=&gt;</span><span style="color:#e6db74">&#34;THREE&#34;</span>}
</span></span></code></pre></div><h2 id="the-cold-never-bothered-me-anyway">The Cold Never Bothered Me Anyway <a href="#the-cold-never-bothered-me-anyway">ðŸ”—</a></h2>
<p><code>HashWithIndifferentAccess</code> provides another way you can accidentally allow changes to a frozen hash.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ruby" data-lang="ruby"><span style="display:flex;"><span>irb(main):<span style="color:#ae81ff">001</span>:<span style="color:#ae81ff">0</span><span style="color:#f92672">&gt;</span> frozen <span style="color:#f92672">=</span> { <span style="color:#e6db74">a</span>: <span style="color:#ae81ff">1</span> }<span style="color:#f92672">.</span>freeze
</span></span><span style="display:flex;"><span><span style="color:#f92672">=&gt;</span> {<span style="color:#e6db74">:a</span><span style="color:#f92672">=&gt;</span><span style="color:#ae81ff">1</span>}
</span></span><span style="display:flex;"><span>irb(main):<span style="color:#ae81ff">002</span>:<span style="color:#ae81ff">0</span><span style="color:#f92672">&gt;</span> frozen<span style="color:#f92672">[</span><span style="color:#e6db74">:a</span><span style="color:#f92672">]</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span>
</span></span><span style="display:flex;"><span>(irb):<span style="color:#ae81ff">2</span><span style="color:#e6db74">:in</span> <span style="color:#f92672">&lt;</span>main<span style="color:#f92672">&gt;</span><span style="color:#e6db74">&#39;: can&#39;</span>t modify frozen <span style="color:#e6db74">Hash</span>: {<span style="color:#e6db74">:a</span><span style="color:#f92672">=&gt;</span><span style="color:#ae81ff">1</span>} (<span style="color:#66d9ef">FrozenError</span>)
</span></span><span style="display:flex;"><span>irb(main):<span style="color:#ae81ff">003</span>:<span style="color:#ae81ff">0</span><span style="color:#f92672">&gt;</span> indifferent <span style="color:#f92672">=</span> frozen<span style="color:#f92672">.</span>with_indifferent_access
</span></span><span style="display:flex;"><span><span style="color:#f92672">=&gt;</span> {<span style="color:#e6db74">&#34;a&#34;</span><span style="color:#f92672">=&gt;</span><span style="color:#ae81ff">1</span>}
</span></span><span style="display:flex;"><span>irb(main):<span style="color:#ae81ff">004</span>:<span style="color:#ae81ff">0</span><span style="color:#f92672">&gt;</span> indifferent<span style="color:#f92672">[</span><span style="color:#e6db74">:a</span><span style="color:#f92672">]</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">=&gt;</span> <span style="color:#ae81ff">2</span>
</span></span><span style="display:flex;"><span>irb(main):<span style="color:#ae81ff">005</span>:<span style="color:#ae81ff">0</span><span style="color:#f92672">&gt;</span> indifferent
</span></span><span style="display:flex;"><span><span style="color:#f92672">=&gt;</span> {<span style="color:#e6db74">&#34;a&#34;</span><span style="color:#f92672">=&gt;</span><span style="color:#ae81ff">2</span>}
</span></span></code></pre></div><p>Here I created a frozen hash and could not modify it. I then called <code>with_indifferent_access</code> on it. The resulting <code>HashWithIndifferentAccess</code> <em>could</em> change - even with the original hash frozen.</p>
<h2 id="brain-freeze">Brain Freeze <a href="#brain-freeze">ðŸ”—</a></h2>
<p>Originally I guessed that maybe <code>HashWithIndifferentAccess</code> is using the <code>dup</code> <a href="https://ruby-doc.org/core-3.1.2/Object.html#method-i-dup">method</a>. That does not preserve the frozen status of what it&rsquo;s duplicating.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ruby" data-lang="ruby"><span style="display:flex;"><span>irb(main):<span style="color:#ae81ff">001</span>:<span style="color:#ae81ff">0</span><span style="color:#f92672">&gt;</span> frozen <span style="color:#f92672">=</span> { <span style="color:#e6db74">a</span>: <span style="color:#ae81ff">1</span> }<span style="color:#f92672">.</span>freeze
</span></span><span style="display:flex;"><span><span style="color:#f92672">=&gt;</span> {<span style="color:#e6db74">:a</span><span style="color:#f92672">=&gt;</span><span style="color:#ae81ff">1</span>}
</span></span><span style="display:flex;"><span>irb(main):<span style="color:#ae81ff">002</span>:<span style="color:#ae81ff">0</span><span style="color:#f92672">&gt;</span> frozen<span style="color:#f92672">.</span>frozen?
</span></span><span style="display:flex;"><span><span style="color:#f92672">=&gt;</span> <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>irb(main):<span style="color:#ae81ff">003</span>:<span style="color:#ae81ff">0</span><span style="color:#f92672">&gt;</span> duplicated <span style="color:#f92672">=</span> h<span style="color:#f92672">.</span>dup
</span></span><span style="display:flex;"><span><span style="color:#f92672">=&gt;</span> {<span style="color:#e6db74">:a</span><span style="color:#f92672">=&gt;</span><span style="color:#ae81ff">1</span>}
</span></span><span style="display:flex;"><span>irb(main):<span style="color:#ae81ff">004</span>:<span style="color:#ae81ff">0</span><span style="color:#f92672">&gt;</span> duplicated<span style="color:#f92672">.</span>frozen?
</span></span><span style="display:flex;"><span><span style="color:#f92672">=&gt;</span> <span style="color:#66d9ef">false</span>
</span></span></code></pre></div><p>As an aside, <code>clone</code> <em>will</em> preserve the frozen status.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ruby" data-lang="ruby"><span style="display:flex;"><span>irb(main):<span style="color:#ae81ff">001</span>:<span style="color:#ae81ff">0</span><span style="color:#f92672">&gt;</span> frozen <span style="color:#f92672">=</span> { <span style="color:#e6db74">a</span>: <span style="color:#ae81ff">1</span> }<span style="color:#f92672">.</span>freeze
</span></span><span style="display:flex;"><span><span style="color:#f92672">=&gt;</span> {<span style="color:#e6db74">:a</span><span style="color:#f92672">=&gt;</span><span style="color:#ae81ff">1</span>}
</span></span><span style="display:flex;"><span>irb(main):<span style="color:#ae81ff">002</span>:<span style="color:#ae81ff">0</span><span style="color:#f92672">&gt;</span> frozen<span style="color:#f92672">.</span>frozen?
</span></span><span style="display:flex;"><span><span style="color:#f92672">=&gt;</span> <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>irb(main):<span style="color:#ae81ff">003</span>:<span style="color:#ae81ff">0</span><span style="color:#f92672">&gt;</span> cloned <span style="color:#f92672">=</span> h<span style="color:#f92672">.</span>clone
</span></span><span style="display:flex;"><span><span style="color:#f92672">=&gt;</span> {<span style="color:#e6db74">:a</span><span style="color:#f92672">=&gt;</span><span style="color:#ae81ff">1</span>}
</span></span><span style="display:flex;"><span>irb(main):<span style="color:#ae81ff">004</span>:<span style="color:#ae81ff">0</span><span style="color:#f92672">&gt;</span> cloned<span style="color:#f92672">.</span>frozen?
</span></span><span style="display:flex;"><span><span style="color:#f92672">=&gt;</span> <span style="color:#66d9ef">true</span>
</span></span></code></pre></div><p>However, my intuition was wrong. <code>dup</code> doesn&rsquo;t play a role in the source code. The constructor for <code>HashWithIndifferentAccess</code> takes an argument. In our case it&rsquo;s our original frozen hash. It will <a href="https://github.com/rails/rails/blob/7-0-stable/activesupport/lib/active_support/hash_with_indifferent_access.rb#L71">pass that argument</a> to its <code>update</code> method.</p>
<p>That will eventually <a href="https://github.com/rails/rails/blob/7-0-stable/activesupport/lib/active_support/hash_with_indifferent_access.rb#L412-L417">iterate</a> through each key, value pair in the original hash and write it to the <code>HashWithIndifferentAccess</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ruby" data-lang="ruby"><span style="display:flex;"><span>other_hash<span style="color:#f92672">.</span>to_hash<span style="color:#f92672">.</span>each_pair <span style="color:#66d9ef">do</span> <span style="color:#f92672">|</span>key, value<span style="color:#f92672">|</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> block <span style="color:#f92672">&amp;&amp;</span> key?(key)
</span></span><span style="display:flex;"><span>    value <span style="color:#f92672">=</span> block<span style="color:#f92672">.</span>call(convert_key(key), self<span style="color:#f92672">[</span>key<span style="color:#f92672">]</span>, value)
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>    regular_writer(convert_key(key), convert_value(value))
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">end</span>
</span></span></code></pre></div><p>The <code>regular_writer</code> method is an <a href="https://github.com/rails/rails/blob/7-0-stable/activesupport/lib/active_support/hash_with_indifferent_access.rb#L87">alias</a> for <code>[]=</code>.</p>
<p><code>HashWithIndifferentAccess</code> is also indifferent about the original hash&rsquo;s frozen status. It constructs a new hash, or hash-like object, setting its keys and values based on the original hash. Whether that original hash is frozen or not doesn&rsquo;t matter. The new hash-like object is not.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ruby" data-lang="ruby"><span style="display:flex;"><span>irb(main):<span style="color:#ae81ff">001</span>:<span style="color:#ae81ff">0</span><span style="color:#f92672">&gt;</span> frozen <span style="color:#f92672">=</span> { <span style="color:#e6db74">a</span>: <span style="color:#ae81ff">1</span> }<span style="color:#f92672">.</span>freeze
</span></span><span style="display:flex;"><span><span style="color:#f92672">=&gt;</span> {<span style="color:#e6db74">:a</span><span style="color:#f92672">=&gt;</span><span style="color:#ae81ff">1</span>}
</span></span><span style="display:flex;"><span>irb(main):<span style="color:#ae81ff">002</span>:<span style="color:#ae81ff">0</span><span style="color:#f92672">&gt;</span> frozen<span style="color:#f92672">.</span>frozen?
</span></span><span style="display:flex;"><span><span style="color:#f92672">=&gt;</span> <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>irb(main):<span style="color:#ae81ff">003</span>:<span style="color:#ae81ff">0</span><span style="color:#f92672">&gt;</span> frozen<span style="color:#f92672">.</span>with_indifferent_access<span style="color:#f92672">.</span>frozen?
</span></span><span style="display:flex;"><span><span style="color:#f92672">=&gt;</span> <span style="color:#66d9ef">false</span>
</span></span></code></pre></div><p>The frozen status of the <em>values</em> do carry over though.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ruby" data-lang="ruby"><span style="display:flex;"><span>irb(main):<span style="color:#ae81ff">001</span>:<span style="color:#ae81ff">0</span><span style="color:#f92672">&gt;</span> frozen <span style="color:#f92672">=</span> { <span style="color:#e6db74">a</span>: <span style="color:#e6db74">&#34;not changing&#34;</span><span style="color:#f92672">.</span>freeze }<span style="color:#f92672">.</span>freeze
</span></span><span style="display:flex;"><span><span style="color:#f92672">=&gt;</span> {<span style="color:#e6db74">:a</span><span style="color:#f92672">=&gt;</span><span style="color:#e6db74">&#34;not changing&#34;</span>}
</span></span><span style="display:flex;"><span>irb(main):<span style="color:#ae81ff">002</span>:<span style="color:#ae81ff">0</span><span style="color:#f92672">&gt;</span> indifferent <span style="color:#f92672">=</span> frozen<span style="color:#f92672">.</span>with_indifferent_access
</span></span><span style="display:flex;"><span><span style="color:#f92672">=&gt;</span> {<span style="color:#e6db74">&#34;a&#34;</span><span style="color:#f92672">=&gt;</span><span style="color:#e6db74">&#34;not changing&#34;</span>}
</span></span><span style="display:flex;"><span>irb(main):<span style="color:#ae81ff">003</span>:<span style="color:#ae81ff">0</span><span style="color:#f92672">&gt;</span> indifferent<span style="color:#f92672">[</span><span style="color:#e6db74">:a</span><span style="color:#f92672">].</span>upcase!
</span></span><span style="display:flex;"><span>(irb):<span style="color:#ae81ff">8</span><span style="color:#e6db74">:in</span> <span style="color:#e6db74">`upcase!&#39;: can&#39;t modify frozen String: &#34;not changing&#34; (FrozenError)
</span></span></span></code></pre></div><p>The string in the value of <code>:a</code> is still frozen, even after making it a hash with indifferent access.</p>
<h2 id="things-got-real-quiet-real-fast-tenth-avenue-freeze-out">Things Got Real Quiet Real Fast (Tenth Avenue Freeze-out) <a href="#things-got-real-quiet-real-fast-tenth-avenue-freeze-out">ðŸ”—</a></h2>
<p>Calling <code>freeze</code> on an object does give you certain (limited) immutability guarantees. Be particularly mindful of how you&rsquo;re interacting with a frozen object. In my case, calling <code>h.freeze.with_indifferent_access</code> left me <em>thinking</em> I was working with a frozen hash with indifferent access. I was wrong. Flipping the order, and calling <code>h.with_indifferent_access.freeze</code> <em>does</em> give me what I was expecting.</p>
<p>Stay cool!</p>


</article>


<section class="post-nav">
    <ul>
        
        <li>
            <a href="https://kevinjmurphy.com/posts/ruby-on-rails-podcast-appearance/"><i class="fa fa-chevron-circle-left"></i> Ruby on Rails Podcast Appearance</a>
        </li>
        
        
        <li>
            <a href="https://kevinjmurphy.com/posts/blue-ridge-ruby-2023/">Speaking at Blue Ridge Ruby <i class="fa fa-chevron-circle-right"></i> </a>
        </li>
        
    </ul>
</section>
  
    
    
  





</main>
    <footer>
      <script async data-uid="7a2e7a1bb1" src="https://kevinjmurphy.ck.page/7a2e7a1bb1/index.js"></script>

        <h6>Copyright Â© 2023 - Kevin Murphy |
            Rendered by <a href="https://gohugo.io" title="Hugo">Hugo</a> |
            <a href="https://kevinjmurphy.com/index.xml">RSS </a></h6>
    </footer>
</div>
<script src="https://kevinjmurphy.com/js/scripts.js"></script>

  
<script async src="https://www.googletagmanager.com/gtag/js?id=G-RVD6VLNE04"></script>
<script>
var doNotTrack = false;
if (!doNotTrack) {
	window.dataLayer = window.dataLayer || [];
	function gtag(){dataLayer.push(arguments);}
	gtag('js', new Date());
	gtag('config', 'G-RVD6VLNE04', { 'anonymize_ip': false });
}
</script>


</body>

</html>

