<!doctype html>

<html lang="en">

<head>
  <title>Finding an Initially Confusing Result in Rails - Kevin Murphy</title>
  <meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<meta name="description" content="Rails&#39; find_or_initialize_by method accepts an optional block, but that block is only executed when an existing record is not found by the provided attributes." />
<meta name="author" content="Kevin Murphy" />

<link rel="canonical" href="https://kevinjmurphy.com/posts/find-or-initialize-by-block/">
<meta property="og:title" content="Finding an Initially Confusing Result in Rails" />
<meta property="og:description" content="Rails&#39; find_or_initialize_by method accepts an optional block, but that block is only executed when an existing record is not found by the provided attributes." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://kevinjmurphy.com/posts/find-or-initialize-by-block/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-03-14T07:30:41-04:00" />
<meta property="article:modified_time" content="2022-03-14T07:30:41-04:00" />


<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Finding an Initially Confusing Result in Rails"/>
<meta name="twitter:description" content="Rails&#39; find_or_initialize_by method accepts an optional block, but that block is only executed when an existing record is not found by the provided attributes."/>

<meta name="generator" content="Hugo 0.88.1" />
    

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.1/normalize.min.css" integrity="sha256-l85OmPOjvil/SOvVt3HnSSjzF1TUMyT9eV0c2BzEGzU=" crossorigin="anonymous" />
  <link rel="stylesheet" href="https://kevinjmurphy.com/fontawesome/css/all.min.css" />
  
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto+Slab|Ruda" />
  
  
  <link rel="stylesheet" type="text/css" href="https://kevinjmurphy.com/css/styles.css" /><link rel='stylesheet' href='https://kevinjmurphy.com/css/link-style.css'><link rel='stylesheet' href='https://kevinjmurphy.com/css/code-scroll.css'><link rel='stylesheet' href='https://kevinjmurphy.com/css/coverage-emoji.css'></head>

<body>
  <div id="container">
    <header>
      <h1>
                <a href="https://kevinjmurphy.com/">Kevin Murphy</a>
            </h1>

      <ul id="social-media">
             <li>
               <a href="https://github.com/kevin-j-m" title="GitHub">
               <i class="fab fa-github fa-lg"></i>
               </a>
             </li>
             <li>
               <a href="https://twitter.com/kevin_j_m" title="Twitter">
               <i class="fab fa-twitter fa-lg"></i>
               </a>
             </li>
             <li>
               <a href="https://linkedin.com/in/kevinmurphydev" title="LinkedIn">
               <i class="fab fa-linkedin fa-lg"></i>
               </a>
             </li>
             <li>
               <a href="https://dev.to/kevin_j_m" title="devto">
               <i class="fab fa-dev fa-lg"></i>
               </a>
             </li>
      </ul>
      
      <p><em>Software Developer</em></p>
      
    </header>

    
<nav>
    <ul>
        
        <li>
            <a class="" href="https://kevinjmurphy.com/">
                <i class="fa-li fa  fa-lg"></i><span>Home</span>
            </a>
        </li>
        
        <li>
            <a class="" href="https://kevinjmurphy.com/about/">
                <i class="fa-li fa  fa-lg"></i><span>About</span>
            </a>
        </li>
        
        <li>
            <a class="" href="https://kevinjmurphy.com/speaking/">
                <i class="fa-li fa  fa-lg"></i><span>Speaking</span>
            </a>
        </li>
        
    </ul>
</nav>


    <main>




<article>

    <h1>Finding an Initially Confusing Result in Rails</h1>

    
      <aside>
    <ul>
        <li>
            <time class="post-date" datetime="2022-03-14T07:30:41-04:00">Mar 14, 2022</time>
        </li>
        
        

        
        <li>
            <em>
                
                    
                    <a href="https://kevinjmurphy.com/tags/ruby">#ruby</a>
                
                    , 
                    <a href="https://kevinjmurphy.com/tags/rails">#rails</a>
                
            </em>
        </li>
        

        <li>2 minute read | 416 words</li>
    </ul>
</aside>

    

    


    <h2 id="initial-impressions">Initial Impressions <a href="#initial-impressions">ðŸ”—</a></h2>
<p>We run into an old friend Bob and a new friend Carol on the street. Bob recently got married and changed their last name. We&rsquo;re meeting Carol for the first time. We update our mental Rolodex of friends during this meeting.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="color:#66d9ef">Friend</span><span style="color:#f92672">.</span>create(<span style="color:#e6db74">first_name</span>: <span style="color:#e6db74">&#34;Bob&#34;</span>, <span style="color:#e6db74">last_name</span>: <span style="color:#e6db74">&#34;Smith&#34;</span>)
<span style="color:#66d9ef">Friend</span><span style="color:#f92672">.</span>where(<span style="color:#e6db74">first_name</span>: <span style="color:#e6db74">&#34;Carol&#34;</span>)<span style="color:#f92672">.</span>count
<span style="color:#f92672">=&gt;</span> <span style="color:#ae81ff">0</span>

<span style="color:#75715e"># Chance encounter on the street</span>

bob <span style="color:#f92672">=</span> <span style="color:#66d9ef">Friend</span><span style="color:#f92672">.</span>find_or_initialize_by(<span style="color:#e6db74">first_name</span>: <span style="color:#e6db74">&#34;Bob&#34;</span>) <span style="color:#66d9ef">do</span> <span style="color:#f92672">|</span>friend<span style="color:#f92672">|</span>
  friend<span style="color:#f92672">.</span>last_name <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Jones&#34;</span>
<span style="color:#66d9ef">end</span>

carol <span style="color:#f92672">=</span> <span style="color:#66d9ef">Friend</span><span style="color:#f92672">.</span>find_or_initialize_by(<span style="color:#e6db74">first_name</span>: <span style="color:#e6db74">&#34;Carol&#34;</span>) <span style="color:#66d9ef">do</span> <span style="color:#f92672">|</span>friend<span style="color:#f92672">|</span>
  friend<span style="color:#f92672">.</span>last_name <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Thompson&#34;</span>
<span style="color:#66d9ef">end</span>
</code></pre></div><p>What are the values of Carol&rsquo;s and Bob&rsquo;s last names in our working memory right now during this encounter?</p>
<h3 id="carols-last-name">Carol&rsquo;s Last Name <a href="#carols-last-name">ðŸ”—</a></h3>
<p>Carol&rsquo;s last name is Thompson. We have no other friends named Carol, so we create a new object and in the block, set their last name to Thompson.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby">carol<span style="color:#f92672">.</span>last_name
<span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">&#34;Thompson&#34;</span>
</code></pre></div><h3 id="bobs-last-name">Bob&rsquo;s Last Name <a href="#bobs-last-name">ðŸ”—</a></h3>
<p>Bob&rsquo;s last name is <em>still</em> &ldquo;Smith&rdquo;, the value it&rsquo;s persisted in our database as.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby">bob<span style="color:#f92672">.</span>last_name
<span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">&#34;Smith&#34;</span>
</code></pre></div><p>Even though in our block, we set their last name to Jones, it didn&rsquo;t take affect. It seems we forgot our friend&rsquo;s new last name! This could lead to an embarrassing situation later on in the conversation. What happened?</p>
<h2 id="finding-the-source-of-the-confusion">Finding The Source of the Confusion <a href="#finding-the-source-of-the-confusion">ðŸ”—</a></h2>
<p>Thanks to Rails' <a href="https://api.rubyonrails.org/v7.0.2/classes/ActiveRecord/Relation.html#method-i-find_or_initialize_by">documentation</a>, we discover the <code>find_or_initialize_by</code> method is in <code>ActiveRecord::Relation</code>. From there, we can look at the <a href="https://github.com/rails/rails/blob/de53ba56cab69fb9707785a397a59ac4aaee9d6f/activerecord/lib/active_record/relation.rb#L226">source code</a> of the method:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">find_or_initialize_by</span>(attributes, <span style="color:#f92672">&amp;</span>block)
  find_by(attributes) <span style="color:#f92672">||</span> <span style="color:#66d9ef">new</span>(attributes, <span style="color:#f92672">&amp;</span>block)
<span style="color:#66d9ef">end</span>
</code></pre></div><h2 id="attributing-the-difference">Attributing The Difference <a href="#attributing-the-difference">ðŸ”—</a></h2>
<p>If we find an existing record by the attributes provided, then we return that record. If not, <code>find_by</code> returns <code>nil</code> and we visit the right-hand side of the expression. That will create a new record with the attributes and <a href="https://kevinjmurphy.com/posts/activerecord-new-block/">pass the block</a> to <code>new</code>. Notice that the block is not executed at all when <code>find_by</code> returns a record.</p>
<h2 id="mistakenly-blocking-out-our-friends-new-name">Mistakenly Blocking Out Our Friend&rsquo;s New Name <a href="#mistakenly-blocking-out-our-friends-new-name">ðŸ”—</a></h2>
<p>That explains why Bob&rsquo;s last name isn&rsquo;t updated in our memory. We documented the change, but it never took effect. <code>find_or_initialize_by</code> didn&rsquo;t use the block. The saved representation for Bob returned from the method without executing the block.</p>
<p>When using <code>find_or_initialize_by</code> with a block, pay careful attention. The block will only execute in one of those conditions - when initializing an object. That may be confusing to yourself and others reading this code in the future. Avoid the block to prevent misunderstanding the state of your record. Make sure you commit your friend&rsquo;s new last name to memory.</p>
<h2 id="finding-the-initial-inspiration">Finding The Initial Inspiration <a href="#finding-the-initial-inspiration">ðŸ”—</a></h2>
<p>Thanks to Ben Drozdoff for the conversation that led to this post.</p>


</article>


<section class="post-nav">
    <ul>
        
        <li>
            <a href="https://kevinjmurphy.com/posts/business-process-management/"><i class="fa fa-chevron-circle-left"></i> Business Process Management: A Developer&#39;s Business</a>
        </li>
        
        
    </ul>
</section>
  
    
    
  





</main>
    <footer>
        <h6>Copyright Â© 2021 - Kevin Murphy |
            Rendered by <a href="https://gohugo.io" title="Hugo">Hugo</a> |
            <a href="https://kevinjmurphy.com/index.xml">Subscribe </a></h6>
    </footer>
</div>
<script src="https://kevinjmurphy.com/js/scripts.js"></script>


</body>

</html>

