<!doctype html>

<html lang="en">

<head>
  <title>Ruby&#39;s Got You Covered - Kevin Murphy</title>
  <meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<meta name="description" content="Ruby&#39;s coverage module includes many options that can answer different questions about your code. This article explores the modes that the module provides." />
<meta name="author" content="Kevin Murphy" />

<link rel="canonical" href="https://kevinjmurphy.com/posts/rubys-got-you-covered/">
<meta property="og:title" content="Ruby&#39;s Got You Covered" />
<meta property="og:description" content="Ruby&#39;s coverage module includes many options that can answer different questions about your code. This article explores the modes that the module provides." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://kevinjmurphy.com/posts/rubys-got-you-covered/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-10-21T20:00:07-04:00" />
<meta property="article:modified_time" content="2021-10-21T20:00:07-04:00" />


<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Ruby&#39;s Got You Covered"/>
<meta name="twitter:description" content="Ruby&#39;s coverage module includes many options that can answer different questions about your code. This article explores the modes that the module provides."/>

<meta name="generator" content="Hugo 0.88.1" />
    

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.1/normalize.min.css" integrity="sha256-l85OmPOjvil/SOvVt3HnSSjzF1TUMyT9eV0c2BzEGzU=" crossorigin="anonymous" />
  <link rel="stylesheet" href="https://kevinjmurphy.com/fontawesome/css/all.min.css" />
  
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto+Slab|Ruda" />
  
  
  <link rel="stylesheet" type="text/css" href="https://kevinjmurphy.com/css/styles.css" /><link rel='stylesheet' href='https://kevinjmurphy.com/css/link-style.css'><link rel='stylesheet' href='https://kevinjmurphy.com/css/code-scroll.css'><link rel='stylesheet' href='https://kevinjmurphy.com/css/coverage-emoji.css'>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-RVD6VLNE04"></script>
<script>
var doNotTrack = false;
if (!doNotTrack) {
	window.dataLayer = window.dataLayer || [];
	function gtag(){dataLayer.push(arguments);}
	gtag('js', new Date());
	gtag('config', 'G-RVD6VLNE04', { 'anonymize_ip': false });
}
</script>

  
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'G-RVD6VLNE04', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

</head>

<body>
  <div id="container">
    <header>
      <h1>
                <a href="https://kevinjmurphy.com/">Kevin Murphy</a>
            </h1>

      <ul id="social-media">
             <li>
               <a href="https://github.com/kevin-j-m" title="GitHub">
               <i class="fab fa-github fa-lg"></i>
               </a>
             </li>
             <li>
               <a href="https://twitter.com/kevin_j_m" title="Twitter">
               <i class="fab fa-twitter fa-lg"></i>
               </a>
             </li>
             <li>
               <a href="https://linkedin.com/in/kevinmurphydev" title="LinkedIn">
               <i class="fab fa-linkedin fa-lg"></i>
               </a>
             </li>
             <li>
               <a href="https://dev.to/kevin_j_m" title="devto">
               <i class="fab fa-dev fa-lg"></i>
               </a>
             </li>
      </ul>
      
      <p><em>Software Developer</em></p>
      
    </header>

    
<nav>
    <ul>
        
        <li>
            <a class="" href="https://kevinjmurphy.com/">
                <i class="fa-li fa  fa-lg"></i><span>Home</span>
            </a>
        </li>
        
        <li>
            <a class="" href="https://kevinjmurphy.com/about/">
                <i class="fa-li fa  fa-lg"></i><span>About</span>
            </a>
        </li>
        
        <li>
            <a class="" href="https://kevinjmurphy.com/speaking/">
                <i class="fa-li fa  fa-lg"></i><span>Speaking</span>
            </a>
        </li>
        
    </ul>
</nav>


    <main>




<article>

    <h1>Ruby&#39;s Got You Covered</h1>

    
      <aside>
    <ul>
        <li>
            <time class="post-date" datetime="2021-10-21T20:00:07-04:00">Oct 21, 2021</time>
        </li>
        
        

        
        <li>
            <em>
                
                    
                    <a href="https://kevinjmurphy.com/tags/ruby">#ruby</a>
                
            </em>
        </li>
        

        <li>9 minute read | 1736 words</li>
    </ul>
</aside>

    

    


    <h2 id="coverage">Coverage <a href="#coverage">ðŸ”—</a></h2>
<p>Perhaps you&rsquo;ve heard of <a href="https://en.wikipedia.org/wiki/Code_coverage">test coverage</a>,
which is a measurement of how much of your application code is executed when
your tests run. That number is typically represented as a percentage, and people
may use that metric to assess the relative health of a codebase. The efficacy of
such metrics is <a href="https://kevinjmurphy.com/posts/remote-ruby-143/">debated</a>, but the metrics are
still prevalent.</p>
<p>This article will demonstrate the mechanism ruby provides to measure coverage
and present some examples for how to use it and is a summary of the information
I shared about coverage at <a href="https://youtu.be/EyLO0EEm3BQ">RubyConf 2020</a>.</p>


<iframe width="560" height="315" src="https://www.youtube.com/embed/EyLO0EEm3BQ" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>


<h2 id="running-coverage">Running Coverage <a href="#running-coverage">ðŸ”—</a></h2>
<p>Ruby ships with a <a href="https://docs.ruby-lang.org/en/3.0.0/Coverage.html">Coverage module</a> as part of the language.
To use it, you must first <code>require</code> the module.</p>
<p>After doing that, you have access to <code>Coverage</code>. Coverage begins running when
you call the <code>start</code> method. It then expects the file you want coverage to be
assessed on to be <code>require</code>d or <code>load</code>ed. Finally, you can see coverage&rsquo;s output
by calling <code>result</code>.</p>
<p>For example, let&rsquo;s say we&rsquo;re all in a band and we&rsquo;re practicing a new
<a href="https://youtu.be/_7Qk9MdyiOM">cover song</a>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="color:#75715e"># rehearsal.rb</span>
our_band <span style="color:#f92672">=</span> <span style="color:#66d9ef">Band</span><span style="color:#f92672">.</span>new(name: <span style="color:#e6db74">&#34;Blogger Band&#34;</span>)

song <span style="color:#f92672">=</span> <span style="color:#66d9ef">CoverMe</span><span style="color:#f92672">.</span>new
song<span style="color:#f92672">.</span>original_artist <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Bruce Springsteen&#34;</span>
song<span style="color:#f92672">.</span>band <span style="color:#f92672">=</span> our_band

song<span style="color:#f92672">.</span>play
</code></pre></div><p>In order to run coverage on this file, we can do the following:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby">require <span style="color:#e6db74">&#34;coverage&#34;</span>

<span style="color:#66d9ef">Coverage</span><span style="color:#f92672">.</span>start
load <span style="color:#e6db74">&#34;rehearsal.rb&#34;</span>
<span style="color:#66d9ef">Coverage</span><span style="color:#f92672">.</span>result
</code></pre></div><h2 id="coverage-modes">Coverage Modes <a href="#coverage-modes">ðŸ”—</a></h2>
<p>Ruby&rsquo;s coverage module has many modes, or different ways of assessing coverage.
Each mode answers a different question about the code that was run under coverage:</p>
<ul>
<li>Lines - how many times was each line executed?</li>
<li>Oneshot Lines - which lines were executed?</li>
<li>Methods - how many times was each method executed?</li>
<li>Branches - how many times was each conditional executed?</li>
</ul>
<p>You can specify which modes to run by passing an argument to <code>Coverage.start</code>.</p>
<h3 id="lines-coverage">Lines Coverage <a href="#lines-coverage">ðŸ”—</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="color:#66d9ef">Coverage</span><span style="color:#f92672">.</span>start(<span style="color:#e6db74">lines</span>: <span style="color:#66d9ef">true</span>)
</code></pre></div><p>This is the mode that runs if you do not pass any arguments to <code>Coverage.start</code>.
Each relevant line has a counter that is incremented each time the line is
visited in code execution while coverage is running. Irrelevant lines, those
that are things like empty lines or <code>end</code> statements, are ignored. At the
conclusion, you will see how many times each line is executed.</p>
<p>Our guitarist wants to track how often they break a string during rehearsal. A
string is broken when the <code>@broken</code> instance variable is set.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">String</span>
  <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">break_string</span>
    @broken <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span>
    <span style="color:#66d9ef">BrokenStringSound</span><span style="color:#f92672">.</span>new
  <span style="color:#66d9ef">end</span>
<span style="color:#66d9ef">end</span>
</code></pre></div><p>Coverage&rsquo;s result provides a hash, where the keys are all the files that were
run while coverage was running. Each value is a hash that has a key for the
mode(s) of coverage run.</p>
<p>For lines coverage, the value of that inner hash is an array showing how many
times each line was executed. The integer at index 0 of this array shows how
many times line 1 was run.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby">{
  <span style="color:#f92672">...</span>
  <span style="color:#e6db74">&#34;string.rb&#34;</span> <span style="color:#f92672">=&gt;</span> {<span style="color:#e6db74">:lines</span> <span style="color:#f92672">=&gt;</span> <span style="color:#f92672">[</span><span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">4</span>, <span style="color:#ae81ff">4</span>, <span style="color:#66d9ef">nil</span>,<span style="color:#f92672">...]</span>},
  <span style="color:#f92672">...</span>
}
</code></pre></div><p>The <code>nil</code> represents an irrelevant line, in this case, an <code>end</code> statement. To
answer our question, we need to see how many times line 3 of the string file was
run, which is index 2 in the array - and we see our guitarist broke 4 strings in
one rehearsal.</p>
<h3 id="oneshot-lines-coverage">Oneshot Lines Coverage <a href="#oneshot-lines-coverage">ðŸ”—</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="color:#66d9ef">Coverage</span><span style="color:#f92672">.</span>start(<span style="color:#e6db74">oneshot_lines</span>: <span style="color:#66d9ef">true</span>)
</code></pre></div><p>Similar to lines coverage, this also documents that a relevant line was executed while coverage was running. However, itâ€™s a binary report of whether it was executed or not. It will not tell you how often. This may be sufficient in many cases, and comes with the benefit of being more performant every subsequent time a particular line of code is executed under coverage.</p>
<p>The drummer has a break in the song where they play a small fill.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Drum</span>
  <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">small_fill</span>
    bang_tom
    roll_snare(<span style="color:#e6db74">duration</span>: <span style="color:#ae81ff">2</span>)

    <span style="color:#66d9ef">if</span> extend_fill?
      hit_crash_cymbal
    <span style="color:#66d9ef">end</span>

    strike_ride_cymbal
  <span style="color:#66d9ef">end</span>
<span style="color:#66d9ef">end</span>
</code></pre></div><p>The band isn&rsquo;t sure if the drummer is hitting the crash cymbal during the fill.
To find out, they can use oneshot lines coverage, which will tell if the line of
code is executed. They don&rsquo;t care how many times; only if it ever happened.</p>
<p>The result looks similar to lines coverage:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby">{
  <span style="color:#f92672">...</span>
  <span style="color:#e6db74">&#34;drum.rb&#34;</span><span style="color:#f92672">=&gt;</span>{<span style="color:#e6db74">:oneshot_lines</span><span style="color:#f92672">=&gt;[</span><span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">2</span>, <span style="color:#ae81ff">7</span>, <span style="color:#ae81ff">3</span>, <span style="color:#f92672">...]</span>},
  <span style="color:#f92672">...</span>
}
</code></pre></div><p>The values in the array are different from lines coverage though. Here, each
integer in the array is a line number that was executed. Remember, oneshot lines
won&rsquo;t tell you how many times a line was run. The order of elements does not
matter, unlike lines coverage.</p>
<p>In the case of our drum fill, 7 is in the array, which is the line number to hit
the crash cymbal, so the drummer is extending the fill.</p>
<h3 id="methods-coverage">Methods Coverage <a href="#methods-coverage">ðŸ”—</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="color:#66d9ef">Coverage</span><span style="color:#f92672">.</span>start(methods: <span style="color:#66d9ef">true</span>)
</code></pre></div><p>Methods coverage brings the granularity of lines coverage up to a coarser grain. Rather than tracking individual lines, itâ€™s concerned with whether a particular method is executed. It can be a 10 line method where the first line is the only line ever executed. Methods coverage will still consider that as executed the same as a 20 line method where each line is executed.</p>
<p>Now that our guitarist knows they break a lot of strings, they need to thin out
the gear they bring to gigs so they have more room in their bag for strings.
They&rsquo;re wondering which effects pedals they&rsquo;re even using on their pedal board.
They have a lot, and each of them responds to <code>trigger</code>, which turns them off
or on when you press them.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ReverbPedal</span>
  <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">trigger</span>
    <span style="color:#f92672">...</span>
  <span style="color:#66d9ef">end</span>
<span style="color:#66d9ef">end</span>

<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">OverdrivePedal</span>
  <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">trigger</span>
    <span style="color:#f92672">...</span>
  <span style="color:#66d9ef">end</span>
<span style="color:#66d9ef">end</span>

<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">DelayPedal</span>
  <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">trigger</span>
    <span style="color:#f92672">...</span>
  <span style="color:#66d9ef">end</span>
<span style="color:#66d9ef">end</span>
</code></pre></div><p>We can use methods coverage to see which of those pedals are being triggered
during rehearsal.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby">{
  <span style="color:#f92672">...</span>
  <span style="color:#e6db74">&#34;reverb_pedal.rb&#34;</span><span style="color:#f92672">=&gt;</span>
    {<span style="color:#e6db74">:methods</span><span style="color:#f92672">=&gt;</span>{<span style="color:#f92672">[</span><span style="color:#66d9ef">ReverbPedal</span>, <span style="color:#e6db74">:trigger</span>, <span style="color:#ae81ff">2</span>, <span style="color:#ae81ff">2</span>, <span style="color:#ae81ff">4</span>, <span style="color:#ae81ff">5</span><span style="color:#f92672">]=&gt;</span><span style="color:#ae81ff">2</span>}},
  <span style="color:#e6db74">&#34;overdrive_pedal.rb&#34;</span><span style="color:#f92672">=&gt;</span>
    {<span style="color:#e6db74">:methods</span><span style="color:#f92672">=&gt;</span>{<span style="color:#f92672">[</span><span style="color:#66d9ef">OverdrivePedal</span>, <span style="color:#e6db74">:trigger</span>, <span style="color:#ae81ff">2</span>, <span style="color:#ae81ff">2</span>, <span style="color:#ae81ff">4</span>, <span style="color:#ae81ff">5</span><span style="color:#f92672">]=&gt;</span><span style="color:#ae81ff">0</span>}},
  <span style="color:#e6db74">&#34;delay_pedal.rb&#34;</span><span style="color:#f92672">=&gt;</span>
    {<span style="color:#e6db74">:methods</span><span style="color:#f92672">=&gt;</span>{<span style="color:#f92672">[</span><span style="color:#66d9ef">DelayPedal</span>, <span style="color:#e6db74">:trigger</span>, <span style="color:#ae81ff">2</span>, <span style="color:#ae81ff">2</span>, <span style="color:#ae81ff">4</span>, <span style="color:#ae81ff">5</span><span style="color:#f92672">]=&gt;</span><span style="color:#ae81ff">3</span>}},
  <span style="color:#f92672">...</span>
}
</code></pre></div><p>Unlike the results we&rsquo;ve seen thus far, this isn&rsquo;t only returning an array in
the value of the mode hash. Instead, there&rsquo;s another hash where the key
identifies the method, and the value is the number of times the method is
executed. Let&rsquo;s dig into what each of the elements identifying a method are.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="color:#f92672">[</span><span style="color:#66d9ef">OverdrivePedal</span>, <span style="color:#e6db74">:trigger</span>,  <span style="color:#ae81ff">2</span>,  <span style="color:#ae81ff">2</span>,  <span style="color:#ae81ff">4</span>,  <span style="color:#ae81ff">5</span><span style="color:#f92672">]</span>
<span style="color:#75715e">#       ^            ^      ^   ^   ^   ^</span>
<span style="color:#75715e">#       |            |      |   |   |   |</span>
<span style="color:#75715e">#     Class          |      |   |   |   |</span>
<span style="color:#75715e">#     Name           |      |   |   |   |</span>
<span style="color:#75715e">#                  Method   |   |   |   |</span>
<span style="color:#75715e">#                  Name     |   |   |   |</span>
<span style="color:#75715e">#                           |   |   |   |</span>
<span style="color:#75715e">#                         Start |   |   |</span>
<span style="color:#75715e">#                         Line  |   |   |</span>
<span style="color:#75715e">#                               |   |   |</span>
<span style="color:#75715e">#                               |   |   |</span>
<span style="color:#75715e">#                             Start |   |</span>
<span style="color:#75715e">#                             Column|   |</span>
<span style="color:#75715e">#                                   |   |</span>
<span style="color:#75715e">#                                   |   |</span>
<span style="color:#75715e">#                                  End  |</span>
<span style="color:#75715e">#                                  Line |</span>
<span style="color:#75715e">#                                       |</span>
<span style="color:#75715e">#                                       |</span>
<span style="color:#75715e">#                                      End</span>
<span style="color:#75715e">#                                      Column</span>
</code></pre></div><p>To help our guitarist clean up their pedal board, we can see that the overdrive
pedal isn&rsquo;t used at all, and can be left at home next time.</p>
<h3 id="branches-coverage">Branches Coverage <a href="#branches-coverage">ðŸ”—</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="color:#66d9ef">Coverage</span><span style="color:#f92672">.</span>start(<span style="color:#e6db74">branches</span>: <span style="color:#66d9ef">true</span>)
</code></pre></div><p>Branches Coverage tracks execution of different conditional paths and documents how often those different paths are run. The unique benefit that this provides over lines coverage is in conditionals that execute multiple code paths in a single line, such as ternary statements. You may have a part of that conditional thatâ€™s never run or tested, but you would not know that if youâ€™re relying on lines coverage alone.</p>
<p>Our singer wants to use an echo effect during the song, and has a friend setting
the intensity as they practice.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">CoverMe</span>
  <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">chorus</span>(number)
    echo_intensity <span style="color:#f92672">=</span> number<span style="color:#f92672">.</span>positive? <span style="color:#f92672">&amp;&amp;</span> number<span style="color:#f92672">.</span>even? ? <span style="color:#ae81ff">10</span> : <span style="color:#ae81ff">30</span>

    <span style="color:#66d9ef">Lyric</span><span style="color:#f92672">.</span>new(<span style="color:#e6db74">line</span>: line, <span style="color:#e6db74">effect</span>: <span style="color:#e6db74">:echo</span>, <span style="color:#e6db74">effect_level</span>: echo_intensity)
  <span style="color:#66d9ef">end</span>
<span style="color:#66d9ef">end</span>
</code></pre></div><p>During one run-through of the song, they&rsquo;re happy with the effect and want to
check how often they used each intensity. Because this is expressed as a
ternary, we <strong>can&rsquo;t</strong> use lines coverage. We could use it if the method were
structured like this:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">chorus</span>(number)
  echo_intensity <span style="color:#f92672">=</span> <span style="color:#66d9ef">if</span> number<span style="color:#f92672">.</span>positive? <span style="color:#f92672">&amp;&amp;</span> number<span style="color:#f92672">.</span>even?
    <span style="color:#ae81ff">10</span>
  <span style="color:#66d9ef">else</span>
    <span style="color:#ae81ff">30</span>
  <span style="color:#66d9ef">end</span>
  <span style="color:#f92672">...</span>
<span style="color:#66d9ef">end</span>
</code></pre></div><p>However, in either case, we <em>can</em> use branches coverage to see which of the
different branches were followed.</p>
<p>The output of branches coverage looks similar to that of methods coverage.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby">{
  <span style="color:#e6db74">&#34;cover_me.rb&#34;</span> <span style="color:#f92672">=&gt;</span> {
    <span style="color:#e6db74">:branches</span> <span style="color:#f92672">=&gt;</span> {
      {
        <span style="color:#f92672">[</span><span style="color:#e6db74">:if</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">34</span>, <span style="color:#ae81ff">25</span>, <span style="color:#ae81ff">34</span>, <span style="color:#ae81ff">67</span><span style="color:#f92672">]</span> <span style="color:#f92672">=&gt;</span> {
          <span style="color:#f92672">[</span><span style="color:#e6db74">:then</span>, <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">34</span>, <span style="color:#ae81ff">60</span>, <span style="color:#ae81ff">34</span>, <span style="color:#ae81ff">62</span><span style="color:#f92672">]</span> <span style="color:#f92672">=&gt;</span> <span style="color:#ae81ff">0</span>,
          <span style="color:#f92672">[</span><span style="color:#e6db74">:else</span>, <span style="color:#ae81ff">2</span>, <span style="color:#ae81ff">34</span>, <span style="color:#ae81ff">65</span>, <span style="color:#ae81ff">34</span>, <span style="color:#ae81ff">67</span><span style="color:#f92672">]</span> <span style="color:#f92672">=&gt;</span> <span style="color:#ae81ff">2</span>,
        }
      }
    }
  }
}
</code></pre></div><p>The differences from methods coverage are:</p>
<ol>
<li>Branches coverage nests each branch within its conditional, so the data
structure is nested one level deeper than methods coverage.</li>
<li>Branches coverage assigns a unique identifier to each conditional or branch.</li>
</ol>
<p>Let&rsquo;s look at what each of the elements identifying a branch are.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby">
<span style="color:#f92672">[</span><span style="color:#e6db74">:then</span>,  <span style="color:#ae81ff">1</span>,  <span style="color:#ae81ff">34</span>,  <span style="color:#ae81ff">60</span>,  <span style="color:#ae81ff">34</span>,  <span style="color:#ae81ff">62</span><span style="color:#f92672">]</span>
<span style="color:#75715e">#   ^    ^   ^    ^    ^    ^</span>
<span style="color:#75715e">#   |    |   |    |    |    |</span>
<span style="color:#75715e"># Branch |   |    |    |    |</span>
<span style="color:#75715e">#        |   |    |    |    |</span>
<span style="color:#75715e">#        Id  |    |    |    |</span>
<span style="color:#75715e">#            |    |    |    |</span>
<span style="color:#75715e">#            |    |    |    |</span>
<span style="color:#75715e">#          Start  |    |    |</span>
<span style="color:#75715e">#          Line   |    |    |</span>
<span style="color:#75715e">#                 |    |    |</span>
<span style="color:#75715e">#                 |    |    |</span>
<span style="color:#75715e">#               Start  |    |</span>
<span style="color:#75715e">#               Column |    |</span>
<span style="color:#75715e">#                      |    |</span>
<span style="color:#75715e">#                      |    |</span>
<span style="color:#75715e">#                     End   |</span>
<span style="color:#75715e">#                     Line  |</span>
<span style="color:#75715e">#                           |</span>
<span style="color:#75715e">#                           |</span>
<span style="color:#75715e">#                          End</span>
<span style="color:#75715e">#                          Column</span>
</code></pre></div><p>Looking at the results, the satisfactory performance had the echo intensity
cranked up the 30 the entire time. The <code>else</code> condition of the ternary was the
only branch executed. Now the band knows how to set the effect for their next
performance.</p>
<h3 id="all-coverage-modes">All Coverage Modes <a href="#all-coverage-modes">ðŸ”—</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="color:#66d9ef">Coverage</span><span style="color:#f92672">.</span>start(<span style="color:#e6db74">:all</span>)
</code></pre></div><p>Passing the <code>:all</code> symbol to <code>Coverage.start</code> will ask it to run every coverage
mode; however, if you inspect the output, you&rsquo;ll notice that one is missing.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby">require <span style="color:#e6db74">&#34;coverage&#34;</span>

<span style="color:#66d9ef">Coverage</span><span style="color:#f92672">.</span>start(<span style="color:#e6db74">:all</span>)
load <span style="color:#e6db74">&#34;rehearsal.rb&#34;</span>
result <span style="color:#f92672">=</span> <span style="color:#66d9ef">Coverage</span><span style="color:#f92672">.</span>result

result<span style="color:#f92672">[</span><span style="color:#e6db74">&#34;guitar.rb&#34;</span><span style="color:#f92672">].</span>keys
<span style="color:#f92672">=&gt;</span> <span style="color:#f92672">[</span><span style="color:#e6db74">:lines</span>, <span style="color:#e6db74">:methods</span>, <span style="color:#e6db74">:branches</span><span style="color:#f92672">]</span>
</code></pre></div><p>Oneshot lines is missing!</p>
<p>Oneshot lines and lines modes <a href="https://github.com/ruby/ruby/blob/d92f09a5eea009fa28cd046e9d0eb698e3d94c5c/ext/coverage/coverage.c#L53">cannot be run at the same time</a>,
so lines coverage
is run, as you can still use it to answer if a line was executed at all.</p>
<h2 id="coverage-in-practice">Coverage In Practice <a href="#coverage-in-practice">ðŸ”—</a></h2>
<p>It may be unlikely that you use the <code>Coverage</code> module directly. However, there
are tools you can use to measure code coverage that builds on this abstraction.</p>
<p>There are many tools for measuring test coverage, but one is <a href="https://github.com/simplecov-ruby/simplecov">SimpleCov</a>. It also
supports <a href="https://github.com/simplecov-ruby/simplecov#branch-coverage-ruby--25">branches coverage</a>. To measure coverage of production code, check out
<a href="https://github.com/danmayer/coverband">Coverband</a>, which you can set up to use <a href="https://github.com/danmayer/coverband/blob/43c5ac94febc7a961346b0e9408d829d4d2ef8ad/test/rails5_dummy/config/coverband.rb#L15">oneshot lines</a> mode.</p>
<p>Ruby&rsquo;s coverage module includes many options that can answer different questions
about your code. What do you think you could use it for in your application?
<a href="https://twitter.com/kevin_j_m">Let me know</a>!</p>


</article>


<section class="post-nav">
    <ul>
        
        <li>
            <a href="https://kevinjmurphy.com/posts/gnarly-endings/"><i class="fa fa-chevron-circle-left"></i> Gnarly Endings</a>
        </li>
        
        
        <li>
            <a href="https://kevinjmurphy.com/posts/vendr-start/">Joining Vendr <i class="fa fa-chevron-circle-right"></i> </a>
        </li>
        
    </ul>
</section>
  
    
    
  





</main>
    <footer>
        <h6>Copyright Â© 2021 - Kevin Murphy |
            Rendered by <a href="https://gohugo.io" title="Hugo">Hugo</a> |
            <a href="https://kevinjmurphy.com/index.xml">Subscribe </a></h6>
    </footer>
</div>
<script src="https://kevinjmurphy.com/js/scripts.js"></script>

  
<script async src="https://www.googletagmanager.com/gtag/js?id=G-RVD6VLNE04"></script>
<script>
var doNotTrack = false;
if (!doNotTrack) {
	window.dataLayer = window.dataLayer || [];
	function gtag(){dataLayer.push(arguments);}
	gtag('js', new Date());
	gtag('config', 'G-RVD6VLNE04', { 'anonymize_ip': false });
}
</script>



</body>

</html>

