<!doctype html>

<html lang="en">

<head>
  <title>Making a (Sidekiq) Batch Recipe - Kevin Murphy</title>
  <meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<meta name="description" content="This post provides an introduction to using Sidekiq batches, which is available in Sidekiq Pro." />
<meta name="author" content="Kevin Murphy" />

<link rel="canonical" href="https://kevinjmurphy.com/posts/making-a-sidekiq-batch-recipe/">
<meta property="og:url" content="https://kevinjmurphy.com/posts/making-a-sidekiq-batch-recipe/">
  <meta property="og:site_name" content="Kevin Murphy">
  <meta property="og:title" content="Making a (Sidekiq) Batch Recipe">
  <meta property="og:description" content="This post provides an introduction to using Sidekiq batches, which is available in Sidekiq Pro.">
  <meta property="og:locale" content="en">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-04-13T18:00:22-04:00">
    <meta property="article:modified_time" content="2024-04-13T18:00:22-04:00">
    <meta property="article:tag" content="Ruby">


  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="Making a (Sidekiq) Batch Recipe">
  <meta name="twitter:description" content="This post provides an introduction to using Sidekiq batches, which is available in Sidekiq Pro.">

<meta name="generator" content="Hugo 0.128.2">
    

  <link rel="stylesheet" href="https://kevinjmurphy.com/css/normalize.min.css" />
  <link rel="stylesheet" href="https://kevinjmurphy.com/fontawesome/css/all.min.css" />
  
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto+Slab|Ruda" />
  
  
  <link rel="stylesheet" type="text/css" href="https://kevinjmurphy.com/css/styles.css" /><link rel='stylesheet' href='https://kevinjmurphy.com/css/link-style.css'><link rel='stylesheet' href='https://kevinjmurphy.com/css/code-scroll.css'><link rel='stylesheet' href='https://kevinjmurphy.com/css/coverage-emoji.css'><link rel='stylesheet' href='https://kevinjmurphy.com/css/header-name.css'><link rel='stylesheet' href='https://kevinjmurphy.com/css/search.css'>
  
    
      <script async src="https://www.googletagmanager.com/gtag/js?id=G-RVD6VLNE04"></script>
      <script>
        var doNotTrack = false;
        if ( false ) {
          var dnt = (navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack);
          var doNotTrack = (dnt == "1" || dnt == "yes");
        }
        if (!doNotTrack) {
          window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments);}
          gtag('js', new Date());
          gtag('config', 'G-RVD6VLNE04');
        }
      </script>
    
  


</head>

<body>
  <div id="container">
    <header>
      <div class="header-name">
        <a href="https://kevinjmurphy.com/">Kevin Murphy</a>
      </div>

      <ul id="social-media">
             <li>
               <a href="https://github.com/kevin-j-m" title="GitHub">
               <i class="fab fa-github fa-lg"></i>
               </a>
             </li>
             <li>
               <a href="https://twitter.com/kevin_j_m" title="Twitter">
               <i class="fab fa-twitter fa-lg"></i>
               </a>
             </li>
             <li>
               <a href="https://linkedin.com/in/kevinmurphydev" title="LinkedIn">
               <i class="fab fa-linkedin fa-lg"></i>
               </a>
             </li>
             <li>
               <a href="https://ruby.social/@kevin_j_m" title="Mastodon">
               <i class="fab fa-mastodon fa-lg"></i>
               </a>
             </li>
             <li>
               <a href="https://dev.to/kevin_j_m" title="devto">
               <i class="fab fa-dev fa-lg"></i>
               </a>
             </li>
        <li>
          <a rel="me" href="https://ruby.social/@kevin_j_m">
          </a>
        </li>
      </ul>
      
      <p><em>Software Developer</em></p>
      
    </header>

    
<nav>
    <ul>
        
        <li>
            <a class="" href="https://kevinjmurphy.com/">
                <i class="fa-li fa  fa-lg"></i><span>Home</span>
            </a>
        </li>
        
        <li>
            <a class="" href="https://kevinjmurphy.com/about/">
                <i class="fa-li fa  fa-lg"></i><span>About</span>
            </a>
        </li>
        
        <li>
            <a class="" href="https://kevinjmurphy.com/speaking/">
                <i class="fa-li fa  fa-lg"></i><span>Speaking</span>
            </a>
        </li>
        
        <li>
            <a class="" href="https://kevinjmurphy.com/search/">
                <i class="fa-li fa  fa-lg"></i><span>Search</span>
            </a>
        </li>
        
        <li>
          <a href="https://newsletter.kevinjmurphy.com">
                <i class="fa-li fa fa-lg"></i><span>Newsletter</span>
          </a>
        </li>
    </ul>
</nav>


    <main>




<article>

    <h1>Making a (Sidekiq) Batch Recipe</h1>

    
      <aside>
    <ul>
        <li>
            <time class="post-date" data-pagefind-sort="date:2024-04-13" datetime="2024-04-13T18:00:22-04:00">Apr 13, 2024</time>
        </li>
        
        

        
        <li>
            <em>
                
                    
                    <a href="https://kevinjmurphy.com/tags/ruby">#ruby</a>
                
            </em>
        </li>
        

        <li>8 minute read | 1552 words</li>
    </ul>
</aside>

    

    
      

    

    <h2 id="the-right-number-of-cooks-in-the-kitchen">The Right Number of Cooks in the Kitchen <a href="#the-right-number-of-cooks-in-the-kitchen">ðŸ”—</a></h2>
<p>Today we&rsquo;re going to make a stew. The recipe has three steps that can all run independently. But when they&rsquo;re done, their output needs to come together to finish the stew.</p>
<p>We&rsquo;ll set each step up as a separate Sidekiq job. The details of each step aren&rsquo;t important for this demonstration.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ruby" data-lang="ruby"><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">GetRawVeggiesWorker</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">include</span> <span style="color:#66d9ef">Sidekiq</span><span style="color:#f92672">::</span><span style="color:#66d9ef">Job</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">perform</span>; <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">GetBaconWorker</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">include</span> <span style="color:#66d9ef">Sidekiq</span><span style="color:#f92672">::</span><span style="color:#66d9ef">Job</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">perform</span>; <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">GetCupOfSoupWorker</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">include</span> <span style="color:#66d9ef">Sidekiq</span><span style="color:#f92672">::</span><span style="color:#66d9ef">Job</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">perform</span>; <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">end</span>
</span></span></code></pre></div><p>We can enqueue these to run by themselves no problem. However, we need to know when they&rsquo;re all done so we can finish our recipe. We can group these together using a <a href="https://sidekiq.org/products/pro.html">Sidekiq Pro</a> feature: batches.</p>
<p>We&rsquo;ll write a series of RSpec tests to explore how to use batches to make our recipe.</p>
<h2 id="tracking-kitchen-progress">Tracking Kitchen Progress <a href="#tracking-kitchen-progress">ðŸ”—</a></h2>
<p>We&rsquo;ll start by creating a batch, and adding our recipe steps to it as jobs. Just like a Sidekiq job has a <code>jid</code> (job ID), a batch has a <code>bid</code> (batch ID). We can use that <code>bid</code> to check on the batch&rsquo;s status thanks to the aptly-named <code>Batch::Status</code> class.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ruby" data-lang="ruby"><span style="display:flex;"><span>it <span style="color:#e6db74">&#34;adds jobs to a batch&#34;</span> <span style="color:#66d9ef">do</span>
</span></span><span style="display:flex;"><span>  recipe <span style="color:#f92672">=</span> <span style="color:#66d9ef">Sidekiq</span><span style="color:#f92672">::</span><span style="color:#66d9ef">Batch</span><span style="color:#f92672">.</span>new
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  recipe<span style="color:#f92672">.</span>jobs <span style="color:#66d9ef">do</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">GetRawVeggiesWorker</span><span style="color:#f92672">.</span>perform_async
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">GetBaconWorker</span><span style="color:#f92672">.</span>perform_async
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">GetCupOfSoupWorker</span><span style="color:#f92672">.</span>perform_async
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  batch_status <span style="color:#f92672">=</span> <span style="color:#66d9ef">Sidekiq</span><span style="color:#f92672">::</span><span style="color:#66d9ef">Batch</span><span style="color:#f92672">::</span><span style="color:#66d9ef">Status</span><span style="color:#f92672">.</span>new(recipe<span style="color:#f92672">.</span>bid)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  expect(batch_status)<span style="color:#f92672">.</span>to have_attributes(
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">total</span>: <span style="color:#ae81ff">3</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">pending</span>: <span style="color:#ae81ff">3</span>,
</span></span><span style="display:flex;"><span>    complete?: <span style="color:#66d9ef">false</span>,
</span></span><span style="display:flex;"><span>  )
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">end</span>
</span></span></code></pre></div><p>After making our batch and checking on the status, we see there are three jobs, but none of them ran. That is because this is in a test, and we&rsquo;re using the <a href="https://github.com/sidekiq/sidekiq/wiki/Testing#testing-worker-queueing-fake">Sidekiq fake adapter</a> by default.</p>
<p>Let&rsquo;s update our test to run the batch jobs <a href="https://github.com/sidekiq/sidekiq/wiki/Testing#testing-workers-inline">inline</a>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ruby" data-lang="ruby"><span style="display:flex;"><span>it <span style="color:#e6db74">&#34;runs the workers in the batch in inline mode&#34;</span> <span style="color:#66d9ef">do</span>
</span></span><span style="display:flex;"><span>  recipe <span style="color:#f92672">=</span> <span style="color:#66d9ef">Sidekiq</span><span style="color:#f92672">::</span><span style="color:#66d9ef">Batch</span><span style="color:#f92672">.</span>new
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">Sidekiq</span><span style="color:#f92672">::</span><span style="color:#66d9ef">Testing</span><span style="color:#f92672">.</span>inline! <span style="color:#66d9ef">do</span>
</span></span><span style="display:flex;"><span>    recipe<span style="color:#f92672">.</span>jobs <span style="color:#66d9ef">do</span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">GetRawVeggiesWorker</span><span style="color:#f92672">.</span>perform_async
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">GetBaconWorker</span><span style="color:#f92672">.</span>perform_async
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">GetCupOfSoupWorker</span><span style="color:#f92672">.</span>perform_async
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  batch_status <span style="color:#f92672">=</span> <span style="color:#66d9ef">Sidekiq</span><span style="color:#f92672">::</span><span style="color:#66d9ef">Batch</span><span style="color:#f92672">::</span><span style="color:#66d9ef">Status</span><span style="color:#f92672">.</span>new(recipe<span style="color:#f92672">.</span>bid)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  expect(batch_status)<span style="color:#f92672">.</span>to have_attributes(
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">pending</span>: <span style="color:#ae81ff">0</span>,
</span></span><span style="display:flex;"><span>    complete?: <span style="color:#66d9ef">true</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">total</span>: <span style="color:#ae81ff">5</span>,
</span></span><span style="display:flex;"><span>  )
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">end</span>
</span></span></code></pre></div><p>The jobs executed and the batch is complete. Note that the total number of jobs is five, even though we enqueued three jobs. Interesting! Let&rsquo;s leave that aside as we explore what to do now that we have a batch that completes.</p>
<h2 id="calling-back-next-steps">Calling (back) next steps <a href="#calling-back-next-steps">ðŸ”—</a></h2>
<p>The reason we created a batch was so we could do something with the results of our jobs when they finished. We wanted them to run independently, so we can take advantage of parallel execution. But we need to have the system take action once they&rsquo;re all done.</p>
<p>Sidekiq batches respond to <a href="https://github.com/sidekiq/sidekiq/wiki/Batches#callbacks">callbacks</a>. We&rsquo;ll focus on two of the three available callbacks: complete and success.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ruby" data-lang="ruby"><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ActingLessonCallback</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">on_complete</span>(status, options)
</span></span><span style="display:flex;"><span>    puts <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">#{</span>options<span style="color:#f92672">[</span><span style="color:#e6db74">&#39;name&#39;</span><span style="color:#f92672">]</span><span style="color:#e6db74">}</span><span style="color:#e6db74"> went to Craft Services&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">on_success</span>(status, options)
</span></span><span style="display:flex;"><span>    puts <span style="color:#e6db74">&#34;Baby, you&#39;ve got a stew goin&#39;&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">end</span>
</span></span></code></pre></div><p>Each callback method accepts two arguments. One for the status, and another for a set of options. We&rsquo;re using those options in the <code>on_complete</code> callback to pass a name to the status message.</p>
<p>Also, I&rsquo;m sorry I misled you earlier. This isn&rsquo;t really about a recipe. It&rsquo;s an <a href="https://www.youtube.com/watch?v=oDOffqDsV5Q">acting lesson</a>.</p>


<iframe width="560" height="315" src="https://www.youtube.com/embed/oDOffqDsV5Q?si=dHN-tl96__zJpc_0" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="strict-origin-when-cross-origin" allowfullscreen></iframe>


<h2 id="getting-an-audition-callback">Getting an audition callback <a href="#getting-an-audition-callback">ðŸ”—</a></h2>
<p>Now we know how to use a callback and we created a class to house our callbacks. Let&rsquo;s put it to use by telling our batch about it, and seeing how they get used.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ruby" data-lang="ruby"><span style="display:flex;"><span>it <span style="color:#e6db74">&#34;runs a callback&#34;</span> <span style="color:#66d9ef">do</span>
</span></span><span style="display:flex;"><span>  acting_lesson <span style="color:#f92672">=</span> <span style="color:#66d9ef">Sidekiq</span><span style="color:#f92672">::</span><span style="color:#66d9ef">Batch</span><span style="color:#f92672">.</span>new
</span></span><span style="display:flex;"><span>  acting_lesson<span style="color:#f92672">.</span>on(<span style="color:#e6db74">:complete</span>, <span style="color:#66d9ef">ActingLessonCallback</span>, <span style="color:#e6db74">&#34;name&#34;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">&#34;Kevin&#34;</span>)
</span></span><span style="display:flex;"><span>  acting_lesson<span style="color:#f92672">.</span>on(<span style="color:#e6db74">:success</span>, <span style="color:#66d9ef">ActingLessonCallback</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">Sidekiq</span><span style="color:#f92672">::</span><span style="color:#66d9ef">Testing</span><span style="color:#f92672">.</span>inline! <span style="color:#66d9ef">do</span>
</span></span><span style="display:flex;"><span>    expect <span style="color:#66d9ef">do</span>
</span></span><span style="display:flex;"><span>      acting_lesson<span style="color:#f92672">.</span>jobs <span style="color:#66d9ef">do</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">GetRawVeggiesWorker</span><span style="color:#f92672">.</span>perform_async
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">GetBaconWorker</span><span style="color:#f92672">.</span>perform_async
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">GetCupOfSoupWorker</span><span style="color:#f92672">.</span>perform_async
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">.</span>to output(<span style="color:#e6db74">&#34;Kevin went to Craft Services</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>\
</span></span><span style="display:flex;"><span>               <span style="color:#e6db74">&#34;Baby, you&#39;ve got a stew goin&#39;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>)<span style="color:#f92672">.</span>to_stdout
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">end</span>
</span></span></code></pre></div><p>We registered our callbacks with the batch using the <code>on</code> method.</p>
<p>Remember those two additional jobs in the prior example? Where we enqueued three jobs, but the total count was five? Those extra jobs were these callbacks firing. Even though we didn&rsquo;t register any callbacks, the events still fired.</p>
<p>In this test our batch executed, triggering both callback events. As expected, the callbacks output their message. Completion! Success!</p>
<h2 id="a-complete-definition-of-success">A complete definition of success <a href="#a-complete-definition-of-success">ðŸ”—</a></h2>
<p>While success and complete may sound similar, they have specific and different meanings. The success callback is perhaps the more obvious one. It triggers when the jobs in the batch have completed successfully.</p>
<p>That means that a batch can complete and not be successful - leading us to the <code>on_complete</code> callback. That fires when all the jobs have executed. Some of the jobs could have failed. Some may be in the retry queue. But they have run at least once.</p>
<p>To show this, let&rsquo;s create a few more Sidekiq jobs. We&rsquo;ll join the steps of our acting lesson together in one job. And we&rsquo;ll create one more that always fails.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ruby" data-lang="ruby"><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ActingLessonWorker</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">include</span> <span style="color:#66d9ef">Sidekiq</span><span style="color:#f92672">::</span><span style="color:#66d9ef">Job</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">perform</span>; <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">HugeMistakeWorker</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">include</span> <span style="color:#66d9ef">Sidekiq</span><span style="color:#f92672">::</span><span style="color:#66d9ef">Job</span>
</span></span><span style="display:flex;"><span>  sidekiq_options <span style="color:#66d9ef">retry</span>: <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">perform</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">raise</span> <span style="color:#e6db74">&#34;I think I&#39;d like my money back&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">end</span>
</span></span></code></pre></div><p>Now we&rsquo;ll run another test, creating a batch with these two jobs. At the end, we&rsquo;ll check the status of the batch.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ruby" data-lang="ruby"><span style="display:flex;"><span>it <span style="color:#e6db74">&#34;completes once each job has run once, regardless of success&#34;</span> <span style="color:#66d9ef">do</span>
</span></span><span style="display:flex;"><span>  drama_coach <span style="color:#f92672">=</span> <span style="color:#66d9ef">Sidekiq</span><span style="color:#f92672">::</span><span style="color:#66d9ef">Batch</span><span style="color:#f92672">.</span>new
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">Sidekiq</span><span style="color:#f92672">::</span><span style="color:#66d9ef">Testing</span><span style="color:#f92672">.</span>inline! <span style="color:#66d9ef">do</span>
</span></span><span style="display:flex;"><span>    expect <span style="color:#66d9ef">do</span>
</span></span><span style="display:flex;"><span>      drama_coach<span style="color:#f92672">.</span>jobs <span style="color:#66d9ef">do</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">ActingLessonWorker</span><span style="color:#f92672">.</span>perform_async
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">HugeMistakeWorker</span><span style="color:#f92672">.</span>perform_async
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">end</span><span style="color:#f92672">.</span>to raise_error <span style="color:#e6db74">&#34;I think I&#39;d like my money back&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  batch_status <span style="color:#f92672">=</span> <span style="color:#66d9ef">Sidekiq</span><span style="color:#f92672">::</span><span style="color:#66d9ef">Batch</span><span style="color:#f92672">::</span><span style="color:#66d9ef">Status</span><span style="color:#f92672">.</span>new(drama_coach<span style="color:#f92672">.</span>bid)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  expect(batch_status)<span style="color:#f92672">.</span>to have_attributes(
</span></span><span style="display:flex;"><span>    complete?: <span style="color:#66d9ef">true</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">total</span>: <span style="color:#ae81ff">4</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">pending</span>: <span style="color:#ae81ff">1</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">failures</span>: <span style="color:#ae81ff">1</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">success_pct</span>: <span style="color:#ae81ff">75</span><span style="color:#f92672">.</span><span style="color:#ae81ff">0</span>,
</span></span><span style="display:flex;"><span>  )
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">end</span>
</span></span></code></pre></div><p>Even though not all the jobs were successful, the batch still reports itself as complete. We can see the failure, and the job that failed as pending. We can also look at the success percentage of the batch to understand that not all the jobs succeeded.</p>
<h2 id="dress-rehearsal-implications">Dress rehearsal implications <a href="#dress-rehearsal-implications">ðŸ”—</a></h2>
<p>Something to be mindful of when running your batches in tests is when the callback will fire. To really have some fun, let&rsquo;s do something I don&rsquo;t reach for often: use a global variable.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ruby" data-lang="ruby"><span style="display:flex;"><span>$global <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span></code></pre></div><p>We&rsquo;ll create a job that increments the global.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ruby" data-lang="ruby"><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">CounterWorker</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">include</span> <span style="color:#66d9ef">Sidekiq</span><span style="color:#f92672">::</span><span style="color:#66d9ef">Job</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">perform</span>
</span></span><span style="display:flex;"><span>    $global <span style="color:#f92672">+=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">end</span>
</span></span></code></pre></div><p>We&rsquo;ll have a callback after the batch succeeds. It outputs how many times the jobs incremented the counter.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ruby" data-lang="ruby"><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">BatchCallback</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">on_success</span>(status, options)
</span></span><span style="display:flex;"><span>    puts <span style="color:#e6db74">&#34;Jobs run: </span><span style="color:#e6db74">#{</span>$global<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">end</span>
</span></span></code></pre></div><p>In our test, we have a batch that fires the callback and enqueues the counter job twice.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ruby" data-lang="ruby"><span style="display:flex;"><span> it <span style="color:#e6db74">&#34;runs the success callback after the first job is run with inline test mode&#34;</span> <span style="color:#66d9ef">do</span>
</span></span><span style="display:flex;"><span>  batch <span style="color:#f92672">=</span> <span style="color:#66d9ef">Sidekiq</span><span style="color:#f92672">::</span><span style="color:#66d9ef">Batch</span><span style="color:#f92672">.</span>new
</span></span><span style="display:flex;"><span>  batch<span style="color:#f92672">.</span>on(<span style="color:#e6db74">:success</span>, <span style="color:#66d9ef">BatchCallback</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">Sidekiq</span><span style="color:#f92672">::</span><span style="color:#66d9ef">Testing</span><span style="color:#f92672">.</span>inline! <span style="color:#66d9ef">do</span>
</span></span><span style="display:flex;"><span>    expect <span style="color:#66d9ef">do</span>
</span></span><span style="display:flex;"><span>      batch<span style="color:#f92672">.</span>jobs <span style="color:#66d9ef">do</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">CounterWorker</span><span style="color:#f92672">.</span>perform_async
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">CounterWorker</span><span style="color:#f92672">.</span>perform_async
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">end</span><span style="color:#f92672">.</span>to output(<span style="color:#e6db74">&#34;Jobs run: 1</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>)<span style="color:#f92672">.</span>to_stdout
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  expect($global)<span style="color:#f92672">.</span>to eq <span style="color:#ae81ff">2</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">end</span>
</span></span></code></pre></div><p>Our global says both jobs ran; however, the output from our callback says only one ran. Both are correct - at different points in time! Remember, these jobs in this <em>test</em> are performed inline. The first counter job was enqueued and run, incrementing the counter. Then Sidekiq checked to see if any other jobs were in the batch. At this point there aren&rsquo;t, so it triggers the callbacks. The success callback outputs that one job ran.</p>
<p>Then, the second job in the batch was enqueued and run, incrementing the counter. The end of our test verifies that the global variable is currently set to two. The callback is not executed again because it already ran.</p>
<p>If you&rsquo;re running batches in tests, want to test the callback of a batch, and the callback depends on the state or results of all the jobs in the batch, you may end up with a surprising result.</p>
<h2 id="bulking-up-mid-rehearsal">Bulking up mid-rehearsal <a href="#bulking-up-mid-rehearsal">ðŸ”—</a></h2>
<p>If you really need to test this, you <em>could</em> work around this by changing how you enqueue the jobs in your batch. Using <a href="https://github.com/sidekiq/sidekiq/wiki/Bulk-Queueing">bulk queueing</a> will get you the result you expect.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ruby" data-lang="ruby"><span style="display:flex;"><span>it <span style="color:#e6db74">&#34;runs the success callback after all jobs run when pushed in bulk with inline test mode&#34;</span> <span style="color:#66d9ef">do</span>
</span></span><span style="display:flex;"><span>  batch <span style="color:#f92672">=</span> <span style="color:#66d9ef">Sidekiq</span><span style="color:#f92672">::</span><span style="color:#66d9ef">Batch</span><span style="color:#f92672">.</span>new
</span></span><span style="display:flex;"><span>  batch<span style="color:#f92672">.</span>on(<span style="color:#e6db74">:success</span>, <span style="color:#66d9ef">BatchCallback</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">Sidekiq</span><span style="color:#f92672">::</span><span style="color:#66d9ef">Testing</span><span style="color:#f92672">.</span>inline! <span style="color:#66d9ef">do</span>
</span></span><span style="display:flex;"><span>    expect <span style="color:#66d9ef">do</span>
</span></span><span style="display:flex;"><span>      batch<span style="color:#f92672">.</span>jobs { <span style="color:#66d9ef">CounterWorker</span><span style="color:#f92672">.</span>perform_bulk(<span style="color:#f92672">[[]</span>, <span style="color:#f92672">[]]</span>) }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">end</span><span style="color:#f92672">.</span>to output(<span style="color:#e6db74">&#34;Jobs run: 2</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>)<span style="color:#f92672">.</span>to_stdout
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  expect($global)<span style="color:#f92672">.</span>to eq <span style="color:#ae81ff">2</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">end</span>
</span></span></code></pre></div><p>This also enqueues two jobs. When run with the inline test adapter, they both run before the batch callbacks fire. So, both the callback and the global are consistent.</p>
<p>I point this out to show you can do this, and also to perhaps introduce bulk queueing to you. However, if your tests rely on this, I would advocate to reconsider your testing strategy. Test the callback in isolation to verify that part of your code. Trust Sidekiq to manage the orchestration of firing the callback for the batch.</p>
<h2 id="a-draining-performance">A draining performance <a href="#a-draining-performance">ðŸ”—</a></h2>
<p>You may recall that our first test didn&rsquo;t run the jobs because we were using the fake test adapter. I have one other word of caution to point out that I noticed using the fake adapter. Draining the queue that the jobs are enqueued in for a batch later in the test also does not trigger the callbacks.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ruby" data-lang="ruby"><span style="display:flex;"><span>it <span style="color:#e6db74">&#34;doesn&#39;t run the success callback of a batch when draining the queue in fake test mode&#34;</span> <span style="color:#66d9ef">do</span>
</span></span><span style="display:flex;"><span>  batch <span style="color:#f92672">=</span> <span style="color:#66d9ef">Sidekiq</span><span style="color:#f92672">::</span><span style="color:#66d9ef">Batch</span><span style="color:#f92672">.</span>new
</span></span><span style="display:flex;"><span>  batch<span style="color:#f92672">.</span>on(<span style="color:#e6db74">:success</span>, <span style="color:#66d9ef">BatchCallback</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  batch<span style="color:#f92672">.</span>jobs <span style="color:#66d9ef">do</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">CounterWorker</span><span style="color:#f92672">.</span>perform_async
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">CounterWorker</span><span style="color:#f92672">.</span>perform_async
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  expect { <span style="color:#66d9ef">CounterWorker</span><span style="color:#f92672">.</span>drain }<span style="color:#f92672">.</span>not_to output(<span style="color:#e6db74">&#34;Jobs run: 2</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>)<span style="color:#f92672">.</span>to_stdout
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  expect($global)<span style="color:#f92672">.</span>to eq <span style="color:#ae81ff">2</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">end</span>
</span></span></code></pre></div><p>Lastly on testing, to have these callbacks fire in tests, you must <a href="https://github.com/sidekiq/sidekiq/wiki/Batches#testing">add middleware</a> to your tests.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ruby" data-lang="ruby"><span style="display:flex;"><span>around(<span style="color:#e6db74">:example</span>) <span style="color:#66d9ef">do</span> <span style="color:#f92672">|</span>example<span style="color:#f92672">|</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">Sidekiq</span><span style="color:#f92672">::</span><span style="color:#66d9ef">Testing</span><span style="color:#f92672">.</span>server_middleware <span style="color:#66d9ef">do</span> <span style="color:#f92672">|</span>chain<span style="color:#f92672">|</span>
</span></span><span style="display:flex;"><span>    chain<span style="color:#f92672">.</span>add <span style="color:#66d9ef">Sidekiq</span><span style="color:#f92672">::</span><span style="color:#66d9ef">Batch</span><span style="color:#f92672">::</span><span style="color:#66d9ef">Server</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  example<span style="color:#f92672">.</span>run
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">Sidekiq</span><span style="color:#f92672">::</span><span style="color:#66d9ef">Testing</span><span style="color:#f92672">.</span>server_middleware <span style="color:#66d9ef">do</span> <span style="color:#f92672">|</span>chain<span style="color:#f92672">|</span>
</span></span><span style="display:flex;"><span>    chain<span style="color:#f92672">.</span>remove <span style="color:#66d9ef">Sidekiq</span><span style="color:#f92672">::</span><span style="color:#66d9ef">Batch</span><span style="color:#f92672">::</span><span style="color:#66d9ef">Server</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">end</span>
</span></span></code></pre></div><h2 id="curtain-call">Curtain call <a href="#curtain-call">ðŸ”—</a></h2>
<p>This has been an introduction to Sidekiq&rsquo;s batch functionality. It <em>also</em> provides a valuable life lesson on acting. Batches can be a great option to parallelize work and report the result of, or combine, those pieces. You can also use it to build complex workflows. Dig into batches in more detail on <a href="https://github.com/sidekiq/sidekiq/wiki/Batches">Sidekiq&rsquo;s wiki</a>.</p>


</article>


<section class="post-nav">
    <ul>
        <li>
        
            <a href="https://kevinjmurphy.com/posts/tracks-not-at-railsconf-2024/"><i class="fa fa-chevron-circle-left"></i> Tracks Not At RailsConf 2024</a>
        
        </li>
        <li>
        
            <a href="https://kevinjmurphy.com/posts/ruby-for-all-guest-2024/">Another Ruby for All Podcast Guest Appearance <i class="fa fa-chevron-circle-right"></i> </a>
        
        </li>
    </ul>
</section>
  
    
    
  





</main>
    <footer>
      <script async data-uid="7a2e7a1bb1" src="https://kevinjmurphy.ck.page/7a2e7a1bb1/index.js"></script>

        <h6>Copyright Â© 2023 - Kevin Murphy |
            Rendered by <a href="https://gohugo.io" title="Hugo">Hugo</a> |
            <a href="https://kevinjmurphy.com/index.xml">RSS </a></h6>
    </footer>
</div>
<script src="https://kevinjmurphy.com/js/scripts.js"></script>

  
  
    
      <script async src="https://www.googletagmanager.com/gtag/js?id=G-RVD6VLNE04"></script>
      <script>
        var doNotTrack = false;
        if ( false ) {
          var dnt = (navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack);
          var doNotTrack = (dnt == "1" || dnt == "yes");
        }
        if (!doNotTrack) {
          window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments);}
          gtag('js', new Date());
          gtag('config', 'G-RVD6VLNE04');
        }
      </script>
    
  



</body>

</html>

